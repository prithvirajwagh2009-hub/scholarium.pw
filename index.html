<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a0907">
<meta name="description" content="Scholarium - Your personal academic companion">
<link rel="manifest" href="data:application/json;charset=utf-8;base64,ewogICJuYW1lIjogIlNjaG9sYXJpdW0gLSBBY2FkZW1pYyBDb21wYW5pb24iLAogICJzaG9ydF9uYW1lIjogIlNjaG9sYXJpdW0iLAogICJkZXNjcmlwdGlvbiI6ICJZb3VyIHBlcnNvbmFsIGFjYWRlbWljIGNvbXBhbmlvbiIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGEwOTA3IiwKICAidGhlbWVfY29sb3IiOiAiIzBhMDkwNyIsCiAgIm9yaWVudGF0aW9uIjogImFueSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0Nzdmcgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHZpZXdCb3g9JzAgMCAxOTIgMTkyJyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzMGEwOTA3Jy8lM0UlM0N0ZXh0IHg9Jzk2JyB5PScxMjAnIGZvbnQtZmFtaWx5PSdzZXJpZicgZm9udC1zaXplPSc5MCcgZmlsbD0nJTIzYzQ5YTNhJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXN0eWxlPSdpdGFsaWMnJTNFUyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgdmlld0JveD0nMCAwIDUxMiA1MTInIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyclM0UlM0NyZWN0IHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyBmaWxsPSclMjMwYTA5MDcnLyUzRSUzQ3RleHQgeD0nMjU2JyB5PSczMjAnIGZvbnQtZmFtaWx5PSdzZXJpZicgZm9udC1zaXplPScyNDAnIGZpbGw9JyUyM2M0OWEzYScgdGV4dC1hbmNob3I9J21pZGRsZScgZm9udC1zdHlsZT0naXRhbGljJyUzRVMlM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
<title>Scholarium ‚Äî Academic Companion</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>

<style>
  :root {
    --bg-deep:    #1a1510;
    --bg-base:    #221d17;
    --bg-card:    #2d2720;
    --bg-raised:  #38302a;
    --bg-hover:   #433a32;
    --border:     #4a3f36;
    --border-lit: #5a4d42;
    --amber:      #d4a854;
    --amber-glow: #e4bc6e;
    --amber-dim:  #9a7b3a;
    --amber-faint:#2d251a;
    --cream:      #f0e5d0;
    --cream-dim:  #c4b39a;
    --cream-faint:#8a7a65;
    --red:        #d85f55;
    --red-faint:  #3a1f1d;
    --green:      #7a9a6a;
    --green-faint:#1d2418;
    --blue:       #5a7a9a;
    --blue-faint: #1a2028;
    --purple:     #8a6aa0;
    --purple-faint:#221a28;
    --teal:       #5a9a85;
    --teal-faint: #1a2520;
    --font-display: 'EB Garamond', 'Libre Baskerville', Georgia, serif;
    --font-body:    'Cormorant Garamond', 'Georgia', serif;
    --font-mono:    'Courier Prime', 'Courier New', monospace;
    --sidebar-w:  240px;
    --radius:     5px;
  }

  /* Oxblood Library Theme */
  body.theme-oxblood {
    --bg-deep:    #1B1A1F;
    --bg-base:    #1B1A1F;
    --bg-card:    #3E2F2A;
    --bg-raised:  #4a3832;
    --bg-hover:   #574139;
    --border:     #5a4840;
    --border-lit: #6b5448;
    --amber:      #B49A7D;
    --amber-glow: #C9B399;
    --amber-dim:  #8a7762;
    --amber-faint:#2d261f;
    --cream:      #E0D3B8;
    --cream-dim:  #b5a995;
    --cream-faint:#75614F;
    --red:        #a84e4e;
    --red-faint:  #2a1f1f;
    --green:      #6b8a65;
    --green-faint:#1a211a;
    --blue:       #5a7090;
    --blue-faint: #1a1f28;
    --purple:     #7a5a80;
    --purple-faint:#211a22;
    --teal:       #5a8075;
    --teal-faint: #1a2220;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; overflow-x: hidden; }
  body {
    background: var(--bg-deep);
    color: var(--cream);
    font-family: var(--font-body);
    font-size: 17px;
    line-height: 1.65;
    min-height: 100vh;
    display: flex;
    width: 100%;
    max-width: 100vw;
  }
  /* ‚îÄ‚îÄ Parchment texture ‚îÄ‚îÄ */
  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:9999;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='5'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
    background-size: 180px;
    opacity: .4;
  }

  /* ‚îÄ‚îÄ Icon styles ‚îÄ‚îÄ */
  .icon-outline {
    display: inline-block;
    width: 22px;
    height: 22px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  #sidebar {
    width: var(--sidebar-w); min-height:100vh; flex-shrink:0;
    background: var(--bg-base);
    border-right: 1px solid var(--border);
    display: flex; flex-direction:column;
    position: fixed; left:0; top:0; bottom:0; z-index:100;
  }
  .sidebar-brand {
    padding: 28px 22px 18px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-brand h1 {
    font-family: var(--font-display);
    font-size: 1.65rem;
    font-weight: 500;
    color: var(--amber-glow);
    letter-spacing:.025em;
    line-height:1.15;
    font-style: italic;
  }
  .sidebar-brand span {
    font-family: var(--font-mono);
    font-size: .7rem;
    color: var(--cream-faint);
    letter-spacing:.18em; 
    text-transform:uppercase;
    display: block;
    margin-top: 4px;
  }
  .sidebar-nav { flex:1; padding: 14px 0; }
  .nav-item {
    display:flex; align-items:center; gap:13px;
    padding: 12px 22px;
    cursor:pointer;
    color: var(--cream-dim);
    font-size: 1rem;
    font-family: var(--font-body);
    transition: all .2s;
    border-left: 3px solid transparent;
    user-select:none;
  }
  .nav-item:hover { color:var(--cream); background:var(--bg-raised); }
  .nav-item.active {
    color: var(--amber-glow);
    background: var(--amber-faint);
    border-left-color: var(--amber);
  }
  .sidebar-footer {
    padding: 18px 22px;
    border-top: 1px solid var(--border);
    font-size: .75rem; 
    color: var(--cream-faint);
    font-family: var(--font-mono);
  }
  .clock { color: var(--amber-dim); }

  /* ‚îÄ‚îÄ Main content ‚îÄ‚îÄ */
  #main {
    margin-left: var(--sidebar-w);
    flex:1; min-height:100vh;
    padding: 36px 40px;
    max-width: calc(100vw - var(--sidebar-w));
    overflow-x: hidden;
  }
  .page { display:none; }
  .page.active { display:block; animation: fadeIn .35s ease; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

  /* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
  .page-header { margin-bottom: 32px; }
  .page-header h2 {
    font-family: var(--font-display);
    font-size: 2.3rem; 
    font-weight:500;
    color: var(--cream);
    line-height:1.1;
    font-style: italic;
  }
  .page-header p { color: var(--cream-dim); font-size:1rem; margin-top:6px; }
  .page-subtitle { 
    color: var(--amber); 
    font-family:var(--font-mono); 
    font-size:.72rem; 
    letter-spacing:.14em; 
    text-transform:uppercase; 
    margin-bottom:6px; 
  }

  /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 22px;
  }
  .card-title {
    font-family: var(--font-display);
    font-size: 1.25rem; 
    font-weight:500;
    color: var(--amber-glow);
    margin-bottom:16px;
    padding-bottom:12px;
    border-bottom: 1px solid var(--border);
    font-style: italic;
  }

  /* ‚îÄ‚îÄ Grid layouts ‚îÄ‚îÄ */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn {
    display:inline-flex; align-items:center; gap:8px;
    padding: 9px 18px;
    border: 1px solid var(--border-lit);
    background: var(--bg-raised);
    color: var(--cream);
    font-family: var(--font-body);
    font-size: .95rem;
    cursor:pointer;
    border-radius: var(--radius);
    transition: all .2s;
  }
  .btn:hover { background: var(--bg-hover); border-color: var(--amber-dim); color:var(--amber-glow); }
  .btn-primary {
    background: var(--amber-faint);
    border-color: var(--amber-dim);
    color: var(--amber-glow);
  }
  .btn-primary:hover { background: var(--amber-dim); color: var(--bg-deep); }
  .btn-sm { padding:6px 13px; font-size:.85rem; }
  .btn-danger { border-color: #5a1e1a; color:#d86058; }
  .btn-danger:hover { background:#2a0f0d; border-color:var(--red); }
  .btn-ghost { border-color:transparent; background:transparent; }
  .btn-ghost:hover { background:var(--bg-raised); border-color:var(--border); }
  .task-filter-btn.active { background:var(--amber-faint); border-color:var(--amber-dim); color:var(--amber-glow); }

  /* ‚îÄ‚îÄ Forms ‚îÄ‚îÄ */
  .form-row { display:grid; gap:13px; margin-bottom:13px; }
  .form-row.cols-2 { grid-template-columns:1fr 1fr; }
  .form-row.cols-3 { grid-template-columns:1fr 1fr 1fr; }
  label { 
    font-size:.85rem; 
    color:var(--cream-dim); 
    display:block; 
    margin-bottom:5px; 
    letter-spacing:.03em;
    font-family: var(--font-body);
  }
  input, select, textarea {
    width:100%;
    background: var(--bg-deep);
    border: 1px solid var(--border-lit);
    color: var(--cream);
    font-family: var(--font-body);
    font-size: .98rem;
    padding: 9px 13px;
    border-radius: var(--radius);
    outline:none;
    transition: border-color .2s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--amber-dim); }
  textarea { resize:vertical; min-height:90px; line-height: 1.6; }
  select option { background: var(--bg-card); }

  /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
  .modal-backdrop {
    position:fixed; inset:0; background:rgba(0,0,0,.75);
    z-index:1000; display:flex; align-items:center; justify-content:center;
    backdrop-filter: blur(3px);
  }
  .modal {
    background: var(--bg-card);
    border: 1px solid var(--border-lit);
    border-radius: var(--radius);
    width:90%; max-width:600px; max-height:85vh; overflow:auto;
    animation: modalIn .25s ease;
    box-shadow: 0 10px 40px rgba(0,0,0,.6);
  }
  @keyframes modalIn { from {opacity:0; transform:scale(.96)} to {opacity:1; transform:scale(1)} }
  .modal-header {
    padding:20px 24px;
    border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center;
  }
  .modal-header h3 {
    font-family: var(--font-display);
    font-size:1.35rem;
    color:var(--amber-glow);
    font-weight:500;
    font-style: italic;
  }
  .modal-close {
    background:none; border:none; color:var(--cream-dim); font-size:1.5rem;
    cursor:pointer; line-height:1; padding:0; width:28px; height:28px;
    transition: color .2s;
  }
  .modal-close:hover { color:var(--cream); }
  .modal-body { padding:24px; }
  .modal-footer {
    padding:18px 24px;
    border-top:1px solid var(--border);
    display:flex; gap:10px; justify-content:flex-end;
  }
  .hidden { display:none!important; }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  #toast {
    position:fixed; bottom:30px; right:30px; z-index:2000;
    background:var(--bg-raised); color:var(--cream);
    border:1px solid var(--amber-dim);
    padding:12px 20px; border-radius:var(--radius);
    box-shadow:0 4px 20px rgba(0,0,0,.5);
    font-family:var(--font-body); font-size:.95rem;
    opacity:0; transform:translateY(20px);
    transition: all .3s;
    pointer-events:none;
  }
  #toast.show { opacity:1; transform:translateY(0); pointer-events:auto; }

  /* ‚îÄ‚îÄ Sync Status ‚îÄ‚îÄ */
  .sync-status {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1500;
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: var(--radius);
    font-size: .8rem;
    color: var(--cream-dim);
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0;
    pointer-events: none;
    transition: opacity .3s;
  }
  .sync-status.show { opacity: 1; }
  .sync-status.syncing { border-color: var(--amber); color: var(--amber); }
  .sync-status.synced { border-color: var(--green); color: var(--green); }
  .sync-status.error { border-color: var(--red); color: var(--red); }
  .sync-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }
  .sync-dot.pulse {
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* ‚îÄ‚îÄ Auth UI ‚îÄ‚îÄ */
  .auth-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg-deep);
    z-index: 5000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 24px;
  }
  .auth-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px;
    max-width: 400px;
    text-align: center;
  }
  .auth-title {
    font-family: var(--font-display);
    font-size: 2rem;
    color: var(--amber-glow);
    margin-bottom: 12px;
    font-style: italic;
  }
  .auth-subtitle {
    color: var(--cream-dim);
    font-size: .95rem;
    margin-bottom: 32px;
  }
  .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-raised);
    border-radius: var(--radius);
    margin-bottom: 16px;
  }
  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid var(--amber);
  }
  .user-name {
    flex: 1;
    text-align: left;
    color: var(--cream);
    font-size: .95rem;
  }
  .user-email {
    color: var(--cream-faint);
    font-size: .75rem;
    font-family: var(--font-mono);
  }

  /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
  .dash-greeting { 
    font-family:var(--font-display); 
    font-size:2.8rem; 
    font-weight:500;
    color:var(--amber-glow); 
    margin-bottom:6px;
    font-style: italic;
  }
  .dash-date { 
    color:var(--cream-faint); 
    font-family:var(--font-mono); 
    font-size:.82rem; 
    letter-spacing:.1em;
    text-transform:uppercase;
  }
  .stat-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:18px; margin-bottom:28px; }
  .stat-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:var(--radius); padding:18px;
    text-align:center;
  }
  .stat-icon { 
    margin-bottom:10px; 
    opacity:.6;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .stat-icon svg {
    width: 32px;
    height: 32px;
  }
  .stat-value { 
    font-family:var(--font-display); 
    font-size:2rem; 
    font-weight:500;
    color:var(--amber-glow);
    line-height:1;
  }
  .stat-label { 
    color:var(--cream-dim); 
    font-size:.82rem; 
    margin-top:6px;
    letter-spacing:.03em;
  }

  /* ‚îÄ‚îÄ Task styles ‚îÄ‚îÄ */
  .task-item {
    background:var(--bg-raised);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px 16px;
    margin-bottom:10px;
    display:flex; align-items:center; gap:12px;
    transition: all .2s;
  }
  .task-item:hover { background:var(--bg-hover); border-color:var(--border-lit); }
  .task-item input[type="checkbox"] {
    width:18px; height:18px; cursor:pointer;
    accent-color: var(--amber);
  }
  .task-content { flex:1; }
  .task-title { 
    color:var(--cream); 
    font-size:1rem; 
    margin-bottom:4px;
    font-family: var(--font-body);
  }
  .task-meta { 
    color:var(--cream-faint); 
    font-size:.82rem;
    font-family: var(--font-mono);
  }
  .task-actions { display:flex; gap:8px; }
  .task-done .task-title { 
    text-decoration:line-through; 
    opacity:.5; 
  }

  /* ‚îÄ‚îÄ Test log table ‚îÄ‚îÄ */
  .test-table {
    width:100%;
    min-width: 600px;
    border-collapse:collapse;
    margin-top:16px;
  }
  .test-table th {
    background:var(--bg-raised);
    color:var(--amber);
    font-family:var(--font-body);
    font-size:.88rem;
    font-weight:500;
    text-align:left;
    padding:12px;
    border-bottom:1px solid var(--border-lit);
    letter-spacing:.03em;
  }
  .test-table td {
    padding:12px;
    border-bottom:1px solid var(--border);
    color:var(--cream);
  }
  .test-table tr:hover { background:var(--bg-raised); }
  .test-score {
    font-family:var(--font-mono);
    color:var(--amber-glow);
    font-weight:500;
  }
  .test-percentage {
    font-size:.85rem;
    color:var(--cream-dim);
    margin-left:8px;
  }

  /* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
  .calendar-controls {
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:20px;
  }
  .calendar-month {
    font-family:var(--font-display);
    font-size:1.3rem;
    font-weight:500;
    color:var(--amber-glow);
    font-style: italic;
  }
  .cal-nav { display:flex; gap:8px; }
  .cal-grid {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
  }
  .cal-day-name {
    text-align:center;
    padding:10px 0;
    font-size:.78rem;
    color:var(--cream-faint);
    font-family:var(--font-mono);
    letter-spacing:.08em;
    text-transform:uppercase;
  }
  .cal-day {
    aspect-ratio:1;
    display:flex; align-items:center; justify-content:center;
    background:var(--bg-raised);
    border:1px solid var(--border);
    border-radius:var(--radius);
    cursor:pointer;
    transition: all .2s;
    position:relative;
    font-family: var(--font-body);
    font-size:.95rem;
  }
  .cal-day:hover { background:var(--bg-hover); border-color:var(--border-lit); }
  .cal-day.other-month { opacity:.3; pointer-events:none; }
  .cal-day.today { 
    border-color:var(--amber); 
    background:var(--amber-faint);
    font-weight:600;
  }
  .cal-day.selected { 
    background:var(--amber-dim); 
    color:var(--bg-deep);
    font-weight:600;
  }
  .cal-day.has-entry::after {
    content:'';
    position:absolute;
    bottom:4px;
    width:4px; height:4px;
    background:var(--amber);
    border-radius:50%;
  }
  .cal-day.has-study::before {
    content:'';
    position:absolute;
    top:4px;
    right:4px;
    width:4px; height:4px;
    background:var(--teal);
    border-radius:50%;
  }
  .cal-day.has-event {
    box-shadow: inset 0 0 0 1.5px var(--purple);
  }

  /* ‚îÄ‚îÄ Study timer ‚îÄ‚îÄ */
  .timer-display {
    font-family:var(--font-mono);
    font-size:5rem;
    color:var(--amber-glow);
    text-align:center;
    margin:40px 0;
    letter-spacing:.05em;
    font-weight:600;
  }
  .timer-controls {
    display:flex;
    gap:12px;
    justify-content:center;
    margin-bottom:30px;
    flex-wrap: wrap;
  }
  
  /* ‚îÄ‚îÄ Brown noise player ‚îÄ‚îÄ */
  .noise-player {
    background:var(--bg-raised);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:18px;
    margin-top:24px;
  }
  .noise-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
  }
  .noise-title {
    font-family:var(--font-display);
    font-size:1.1rem;
    color:var(--amber-glow);
    font-style: italic;
  }
  .noise-toggle {
    padding:6px 16px;
    font-size:.85rem;
  }
  .volume-control {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .volume-label {
    font-size:.82rem;
    color:var(--cream-dim);
    font-family:var(--font-mono);
    min-width:80px;
  }
  .volume-slider {
    flex:1;
    height:6px;
    -webkit-appearance:none;
    appearance:none;
    background:var(--bg-deep);
    border-radius:3px;
    outline:none;
  }
  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance:none;
    appearance:none;
    width:16px;
    height:16px;
    background:var(--amber);
    border-radius:50%;
    cursor:pointer;
    transition: all .2s;
  }
  .volume-slider::-webkit-slider-thumb:hover {
    background:var(--amber-glow);
    transform:scale(1.15);
  }
  .volume-slider::-moz-range-thumb {
    width:16px;
    height:16px;
    background:var(--amber);
    border-radius:50%;
    cursor:pointer;
    border:none;
    transition: all .2s;
  }
  .volume-slider::-moz-range-thumb:hover {
    background:var(--amber-glow);
    transform:scale(1.15);
  }
  
  /* ‚îÄ‚îÄ Fullscreen timer ‚îÄ‚îÄ */
  .fullscreen-timer {
    position:fixed;
    inset:0;
    background:var(--bg-deep);
    z-index:5000;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:40px;
  }
  .fullscreen-timer.active { display:flex; }
  .fullscreen-timer .timer-display {
    font-size:8rem;
    margin:60px 0;
  }
  .fullscreen-close {
    position:absolute;
    top:30px;
    right:30px;
    background:transparent;
    border:1px solid var(--border-lit);
    color:var(--cream);
    padding:10px 20px;
    border-radius:var(--radius);
    cursor:pointer;
    font-family:var(--font-body);
    font-size:.9rem;
    transition: all .2s;
  }
  .fullscreen-close:hover {
    background:var(--bg-card);
    border-color:var(--amber-dim);
    color:var(--amber-glow);
  }

  /* ‚îÄ‚îÄ Mood buttons ‚îÄ‚îÄ */
  .mood-row {
    display:flex;
    gap:10px;
    margin:12px 0;
  }
  .mood-btn {
    padding:8px 16px;
    background:var(--bg-raised);
    border:1px solid var(--border);
    border-radius:var(--radius);
    font-size:1.3rem;
    cursor:pointer;
    transition: all .2s;
    opacity:.6;
  }
  .mood-btn:hover { opacity:1; transform:scale(1.1); }
  .mood-btn.active {
    opacity:1;
    background:var(--amber-faint);
    border-color:var(--amber-dim);
    transform:scale(1.1);
  }

  /* ‚îÄ‚îÄ Empty states ‚îÄ‚îÄ */
  .empty-state {
    text-align:center;
    padding:40px 20px;
    color:var(--cream-faint);
    font-style:italic;
    font-size:.95rem;
  }

  /* ‚îÄ‚îÄ Reflection display ‚îÄ‚îÄ */
  .reflection-card {
    background:var(--bg-raised);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    margin-top:16px;
  }
  .reflection-date {
    font-family:var(--font-mono);
    font-size:.78rem;
    color:var(--amber);
    margin-bottom:8px;
    letter-spacing:.08em;
  }
  .reflection-text {
    color:var(--cream);
    line-height:1.7;
    font-size:.98rem;
  }
  .reflection-mood {
    font-size:1.3rem;
    margin-right:8px;
  }

  /* ‚îÄ‚îÄ Install prompt ‚îÄ‚îÄ */
  .install-prompt {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card);
    border: 1px solid var(--amber-dim);
    padding: 16px 24px;
    border-radius: var(--radius);
    box-shadow: 0 8px 30px rgba(0,0,0,.6);
    z-index: 3000;
    display: none;
    align-items: center;
    gap: 16px;
    max-width: 90%;
  }
  .install-prompt.show { display: flex; }
  .install-prompt-text {
    flex: 1;
    font-size: .95rem;
  }

  /* ‚îÄ‚îÄ Study Analytics ‚îÄ‚îÄ */
  .analytics-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  .summary-stat {
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
  }
  .summary-value {
    font-family: var(--font-display);
    font-size: 1.8rem;
    color: var(--amber-glow);
    font-weight: 500;
    margin-bottom: 4px;
  }
  .summary-label {
    font-size: .82rem;
    color: var(--cream-dim);
  }
  .day-session-card {
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
  }
  .day-session-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }
  .day-session-date {
    font-family: var(--font-display);
    font-size: 1.1rem;
    color: var(--amber-glow);
    font-style: italic;
  }
  .day-session-total {
    font-family: var(--font-mono);
    font-size: .9rem;
    color: var(--amber);
  }
  .session-entry {
    padding: 8px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }
  .session-entry:last-child {
    border-bottom: none;
  }
  .session-subject {
    color: var(--cream);
    font-size: .95rem;
  }
  .session-time {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .session-duration {
    font-family: var(--font-mono);
    color: var(--amber);
    font-size: .85rem;
  }
  .session-timestamp {
    font-family: var(--font-mono);
    color: var(--cream-faint);
    font-size: .75rem;
  }

  /* ‚îÄ‚îÄ Mobile Navigation ‚îÄ‚îÄ */
  #mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-base);
    border-top: 1px solid var(--border);
    z-index: 200;
    padding: 8px 0;
  }
  .mobile-nav-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
  }
  .mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 4px;
    cursor: pointer;
    color: var(--cream-dim);
    font-size: .7rem;
    transition: all .2s;
    border-radius: var(--radius);
  }
  .mobile-nav-item svg {
    width: 20px;
    height: 20px;
    margin-bottom: 4px;
  }
  .mobile-nav-item.active {
    color: var(--amber-glow);
    background: var(--amber-faint);
  }

  @media (max-width: 1024px) {
    :root { --sidebar-w: 200px; }
    .stat-grid { grid-template-columns: repeat(2, 1fr); }
    .grid-2 { grid-template-columns: 1fr; }
    .analytics-summary { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 768px) {
    body { font-size: 16px; display: block; overflow-y: auto; }
    #sidebar { 
      transform: translateX(-100%);
      transition: transform .3s;
      width: 260px;
    }
    #sidebar.mobile-open {
      transform: translateX(0);
    }
    #main {
      margin-left: 0;
      max-width: 100vw;
      width: 100%;
      padding: 20px 16px 80px;
      overflow-x: hidden;
      min-height: 100vh;
    }
    #mobile-nav { display: block; }
    #mobile-theme-toggle { display: block !important; }
    .page-header h2 { font-size: 1.8rem; }
    .dash-greeting { font-size: 2rem; }
    .stat-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
    .stat-card { padding: 14px; }
    .stat-icon svg { width: 24px; height: 24px; }
    .stat-value { font-size: 1.5rem; }
    .stat-label { font-size: .75rem; }
    .card { padding: 16px; }
    .card-title { font-size: 1.1rem; }
    .timer-display { font-size: 3rem; margin: 24px 0; }
    .timer-controls { 
      flex-wrap: wrap;
      gap: 8px;
    }
    .timer-controls .btn { flex: 1; min-width: 80px; }
    .fullscreen-timer .timer-display { font-size: 4rem; }
    .modal { width: 95%; max-width: 95%; }
    .form-row.cols-2 { grid-template-columns: 1fr; }
    .analytics-summary { grid-template-columns: 1fr; }
    .test-table { font-size: .85rem; }
    .test-table th, .test-table td { padding: 8px; }
  }

  @media (max-width: 480px) {
    .page-header h2 { font-size: 1.5rem; }
    .dash-greeting { font-size: 1.6rem; }
    .timer-display { font-size: 2.5rem; }
    .fullscreen-timer .timer-display { font-size: 3.5rem; }
    .btn { padding: 8px 14px; font-size: .88rem; }
    .sidebar-brand h1 { font-size: 1.4rem; }
  }

  /* ‚îÄ‚îÄ Sync indicator ‚Äî subtle icon only ‚îÄ‚îÄ */
  .sync-status {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 1500;
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: .75rem;
    color: var(--cream-faint);
    display: flex;
    align-items: center;
    gap: 6px;
    opacity: 0.4;
    pointer-events: none;
    transition: opacity .3s, border-color .3s, color .3s;
    font-family: var(--font-mono);
  }
  .sync-status.show { opacity: 1; }
  .sync-status.syncing { border-color: var(--amber-dim); color: var(--amber); }
  .sync-status.synced { border-color: var(--green); color: var(--green); }
  .sync-status.error { border-color: var(--red); color: var(--red); opacity: 1; pointer-events: auto; }
  .sync-dot { width:5px; height:5px; border-radius:50%; background:currentColor; }
  .sync-dot.pulse { animation: pulse 1.2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.2} }

  /* ‚îÄ‚îÄ Task filter tabs with counts ‚îÄ‚îÄ */
  .filter-strip {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding-bottom: 4px;
    scrollbar-width: none;
  }
  .filter-strip::-webkit-scrollbar { display: none; }
  .filter-tab {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--cream-dim);
    font-family: var(--font-body);
    font-size: .88rem;
    cursor: pointer;
    white-space: nowrap;
    transition: all .2s;
    flex-shrink: 0;
  }
  .filter-tab:hover { border-color: var(--border-lit); color: var(--cream); }
  .filter-tab.active { background: var(--amber-faint); border-color: var(--amber-dim); color: var(--amber-glow); }
  .filter-tab .tab-count {
    background: var(--bg-raised);
    color: var(--cream-faint);
    font-family: var(--font-mono);
    font-size: .72rem;
    padding: 1px 6px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }
  .filter-tab.active .tab-count { background: var(--amber-dim); color: var(--bg-deep); }

  /* ‚îÄ‚îÄ Task date group header ‚îÄ‚îÄ */
  .task-group-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 16px 0 8px;
  }
  .task-group-header:first-child { margin-top: 0; }
  .task-group-label {
    font-size: .75rem;
    font-family: var(--font-mono);
    color: var(--amber);
    letter-spacing: .1em;
    text-transform: uppercase;
    white-space: nowrap;
  }
  .task-group-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .task-group-count {
    font-size: .72rem;
    font-family: var(--font-mono);
    color: var(--cream-faint);
  }

  /* ‚îÄ‚îÄ Dashboard today agenda ‚îÄ‚îÄ */
  .agenda-strip {
    margin-top: 20px;
  }
  .agenda-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .agenda-item:last-child { border-bottom: none; }
  .agenda-time {
    font-family: var(--font-mono);
    font-size: .78rem;
    color: var(--amber);
    min-width: 48px;
    padding-top: 2px;
  }
  .agenda-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 6px;
    flex-shrink: 0;
  }
  .agenda-content { flex: 1; }
  .agenda-title { color: var(--cream); font-size: .95rem; }
  .agenda-sub { color: var(--cream-faint); font-size: .8rem; font-family: var(--font-mono); }

  /* ‚îÄ‚îÄ Upcoming events strip on calendar ‚îÄ‚îÄ */
  .events-agenda {
    margin-top: 16px;
    border-top: 1px solid var(--border);
    padding-top: 14px;
  }
  .events-agenda-title {
    font-family: var(--font-mono);
    font-size: .72rem;
    color: var(--purple);
    letter-spacing: .1em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  .event-chip {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--purple-faint);
    border: 1px solid var(--purple);
    border-radius: var(--radius);
    margin-bottom: 6px;
    cursor: pointer;
    transition: all .2s;
  }
  .event-chip:hover { background: var(--bg-hover); }
  .event-chip-date {
    font-family: var(--font-mono);
    font-size: .72rem;
    color: var(--purple);
    min-width: 56px;
  }
  .event-chip-title { color: var(--cream); font-size: .9rem; flex: 1; }
  .event-chip-time { font-family: var(--font-mono); font-size: .72rem; color: var(--cream-faint); }

  /* ‚îÄ‚îÄ Mobile slide-up drawer ‚îÄ‚îÄ */
  #mobile-drawer {
    position: fixed;
    bottom: 60px;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border: 1px solid var(--border-lit);
    border-radius: 16px 16px 0 0;
    z-index: 350;
    padding: 0 0 8px;
    transform: translateY(110%);
    transition: transform .32s cubic-bezier(.4,0,.2,1);
    display: none;
    max-height: 75vh;
    overflow-y: auto;
  }
  #mobile-drawer.open {
    transform: translateY(0);
  }
  .drawer-handle {
    width: 36px;
    height: 4px;
    background: var(--border-lit);
    border-radius: 2px;
    margin: 12px auto 8px;
  }
  .drawer-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    padding: 8px 12px 16px;
  }
  .drawer-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 14px 8px;
    border-radius: 10px;
    cursor: pointer;
    color: var(--cream-dim);
    font-size: .78rem;
    font-family: var(--font-body);
    transition: all .2s;
    background: transparent;
    border: 1px solid transparent;
  }
  .drawer-item:hover, .drawer-item:active { background: var(--bg-raised); border-color: var(--border); color: var(--cream); }
  .drawer-item svg { width: 22px; height: 22px; }
  .drawer-section-label {
    font-family: var(--font-mono);
    font-size: .68rem;
    color: var(--cream-faint);
    letter-spacing: .1em;
    text-transform: uppercase;
    padding: 8px 20px 4px;
  }

  /* ‚îÄ‚îÄ Sidebar sync icon ‚îÄ‚îÄ */
  .sidebar-sync-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    margin-left: auto;
    opacity: 0;
    transition: opacity .3s;
  }
  .sidebar-sync-icon.active { opacity: 1; }
  .sidebar-sync-icon.spinning svg { animation: spin .8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ Study streak badge ‚îÄ‚îÄ */
  .streak-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--amber-faint);
    border: 1px solid var(--amber-dim);
    border-radius: 20px;
    padding: 4px 12px;
    font-family: var(--font-mono);
    font-size: .78rem;
    color: var(--amber-glow);
    margin-top: 8px;
  }

  /* ‚îÄ‚îÄ Calendar color-tinted days ‚îÄ‚îÄ */
  .cal-day.has-event { box-shadow: inset 0 0 0 1.5px var(--purple); }

  /* ‚îÄ‚îÄ Page header with sync dot ‚îÄ‚îÄ */
  .page-header-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 32px;
  }
  .page-header-row .page-header { margin-bottom: 0; }
  .header-sync {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-mono);
    font-size: .72rem;
    color: var(--cream-faint);
    opacity: 0;
    transition: opacity .3s;
    padding-top: 6px;
  }
  .header-sync.show { opacity: 1; }
  .header-sync.syncing { color: var(--amber); }
  .header-sync.synced { color: var(--green); }
  .header-sync.error { color: var(--red); opacity: 1; }
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-brand">
    <h1>Scholarium</h1>
    <span>Academic Companion</span>
  </div>
  <div class="sidebar-nav">
    <div class="nav-item active" onclick="showPage('dashboard')">
      <svg class="icon-outline" viewBox="0 0 24 24">
        <rect x="3" y="3" width="7" height="7" rx="1"></rect>
        <rect x="14" y="3" width="7" height="7" rx="1"></rect>
        <rect x="14" y="14" width="7" height="7" rx="1"></rect>
        <rect x="3" y="14" width="7" height="7" rx="1"></rect>
      </svg>
      <span>Dashboard</span>
    </div>
    <div class="nav-item" onclick="showPage('tasks')">
      <svg class="icon-outline" viewBox="0 0 24 24">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
      <span>Task Manager</span>
    </div>
    <div class="nav-item" onclick="showPage('tests')">
      <svg class="icon-outline" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path>
      </svg>
      <span>Test Log</span>
    </div>
    <div class="nav-item" onclick="showPage('analytics')">
      <svg class="icon-outline" viewBox="0 0 24 24">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
      </svg>
      <span>Study Analytics</span>
    </div>
    <div class="nav-item" onclick="showPage('calendar')">
      <svg class="icon-outline" viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <span>Calendar</span>
    </div>
    <div class="nav-item" onclick="showPage('timer')">
      <svg class="icon-outline" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <span>Study Timer</span>
    </div>
  </div>
  <div class="sidebar-footer">
    <div id="user-section" class="hidden" style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border);">
      <div style="font-size:.75rem;color:var(--cream-faint);margin-bottom:6px;">Signed in as:</div>
      <div id="user-display-name" style="font-size:.85rem;color:var(--cream);margin-bottom:2px;"></div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <button class="btn btn-sm btn-ghost" onclick="syncFromCloud()" style="flex:1;font-size:.7rem;">
          <svg class="icon-outline" viewBox="0 0 24 24" style="width:12px;height:12px;">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          Sync
        </button>
        <button class="btn btn-sm btn-ghost" onclick="signOut()" style="flex:1;font-size:.7rem;">Sign Out</button>
      </div>
    </div>
    <div class="clock" id="clock" onclick="tapClock()" style="cursor:pointer;user-select:none;" title="Tap 3x for debug">00:00:00</div>
    <div style="margin-top:8px;color:var(--cream-faint);font-size:.7rem;">
      Est. <span id="year">2026</span>
    </div>
    <button class="btn btn-sm btn-ghost" onclick="toggleTheme()" style="margin-top:12px;width:100%;font-size:.7rem;">
      <svg class="icon-outline" viewBox="0 0 24 24" style="width:14px;height:14px;">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
      <span id="theme-label">Oxblood Theme</span>
    </button>
  </div>
</div>

<!-- Mobile Bottom Navigation -->
<div id="mobile-nav">
  <div class="mobile-nav-grid">
    <div class="mobile-nav-item active" onclick="showPage('dashboard')">
      <svg class="icon-outline" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
      <span>Home</span>
    </div>
    <div class="mobile-nav-item" onclick="showPage('tasks')">
      <svg class="icon-outline" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
      <span>Tasks</span>
    </div>
    <div class="mobile-nav-item" onclick="showPage('timer')">
      <svg class="icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
      <span>Timer</span>
    </div>
    <div class="mobile-nav-item" onclick="showPage('calendar')">
      <svg class="icon-outline" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      <span>Calendar</span>
    </div>
    <div class="mobile-nav-item" onclick="toggleDrawer()">
      <svg class="icon-outline" viewBox="0 0 24 24"><circle cx="5" cy="12" r="1.5" fill="currentColor" stroke="none"></circle><circle cx="12" cy="12" r="1.5" fill="currentColor" stroke="none"></circle><circle cx="19" cy="12" r="1.5" fill="currentColor" stroke="none"></circle></svg>
      <span>More</span>
    </div>
  </div>
</div>

<!-- Mobile Slide-up Drawer -->
<div id="mobile-drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-section-label">Pages</div>
  <div class="drawer-grid">
    <div class="drawer-item" onclick="showPage('analytics'); closeDrawer();">
      <svg class="icon-outline" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
      <span>Analytics</span>
    </div>
    <div class="drawer-item" onclick="showPage('tests'); closeDrawer();">
      <svg class="icon-outline" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path></svg>
      <span>Test Log</span>
    </div>
    <div class="drawer-item" onclick="syncFromCloud(); closeDrawer();">
      <svg class="icon-outline" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
      <span>Sync Now</span>
    </div>
  </div>
  <div class="drawer-section-label">Settings</div>
  <div class="drawer-grid" style="padding-bottom:20px;">
    <div class="drawer-item" onclick="showSyncDebug(); closeDrawer();">
      <svg class="icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"></path></svg>
      <span>Sync Debug</span>
    </div>
    <div class="drawer-item" onclick="toggleTheme(); closeDrawer();">
      <svg class="icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
      <span id="drawer-theme-label">Theme</span>
    </div>
    <div class="drawer-item" id="drawer-signin-btn" onclick="signInWithGoogle(); closeDrawer();">
      <svg class="icon-outline" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      <span id="drawer-auth-label">Sign In</span>
    </div>
    <div class="drawer-item" onclick="signOut(); closeDrawer();" id="drawer-signout-btn" style="display:none;">
      <svg class="icon-outline" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
      <span>Sign Out</span>
    </div>
  </div>
</div>
<div id="mobile-drawer-backdrop" onclick="closeDrawer()" style="display:none; position:fixed; inset:0; z-index:340; background:rgba(0,0,0,.45);"></div>

<!-- Main Content -->
<div id="main">
  
  <!-- Dashboard Page -->
  <div id="page-dashboard" class="page active">
    <div class="page-header">
      <div class="page-subtitle">OVERVIEW</div>
      <h2 class="dash-greeting" id="dash-greeting">Good Morning</h2>
      <div class="dash-date" id="dash-date-full">Monday, January 1, 2026</div>
    </div>

    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" class="icon-outline">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
        </div>
        <div class="stat-value" id="s-tasks-due">0</div>
        <div class="stat-label">Tasks Due Soon</div>
      </div>
      <div class="stat-card" style="display:flex;align-items:center;justify-content:center;border:none;background:transparent;">
        <svg viewBox="0 0 100 120" style="width:80px;height:96px;opacity:.25;">
          <path d="M50,10 L60,40 L90,40 L65,60 L75,90 L50,70 L25,90 L35,60 L10,40 L40,40 Z" 
                fill="none" stroke="var(--amber)" stroke-width="2"/>
        </svg>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" class="icon-outline">
            <polyline points="9 11 12 14 22 4"></polyline>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
        </div>
        <div class="stat-value" id="s-done">0</div>
        <div class="stat-label">Completed Tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" class="icon-outline">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="stat-value" id="s-study">0h</div>
        <div class="stat-label">Study Time (7d)</div>
      </div>
    </div>

    <!-- Today's Agenda -->
    <div class="card" style="margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div class="card-title" style="margin:0;padding:0;border:none;">Today's Agenda</div>
        <div id="streak-badge-wrap"></div>
      </div>
      <div id="dash-agenda" style="margin-top:12px;">
        <div class="empty-state" style="padding:20px;">Nothing scheduled today</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">Today's Reflection</div>
        <div class="mood-row" id="dash-mood-row">
          <button class="mood-btn" onclick="setDashMood('üòä')">üòä</button>
          <button class="mood-btn" onclick="setDashMood('üòê')">üòê</button>
          <button class="mood-btn" onclick="setDashMood('üòî')">üòî</button>
          <button class="mood-btn" onclick="setDashMood('üò§')">üò§</button>
          <button class="mood-btn" onclick="setDashMood('ü§î')">ü§î</button>
        </div>
        <textarea id="dash-journal-text" placeholder="How was your day? What did you learn?"></textarea>
        <div style="margin-top:12px;">
          <button class="btn btn-primary" onclick="saveDashJournal()">Save Reflection</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Upcoming Tasks</div>
        <div id="dash-upcoming-tasks">
          <div class="empty-state">No tasks yet.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Manager Page -->
  <div id="page-tasks" class="page">
    <div class="page-header">
      <div class="page-subtitle">ORGANIZE</div>
      <h2>Task Manager</h2>
      <p>Keep track of all your assignments and deadlines</p>
    </div>
    
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
      <div class="filter-strip" id="task-filter-strip">
        <button class="filter-tab active" onclick="setTaskFilter('all')" data-filter="all">All <span class="tab-count" id="fc-all">0</span></button>
        <button class="filter-tab" onclick="setTaskFilter('today')" data-filter="today">Today <span class="tab-count" id="fc-today">0</span></button>
        <button class="filter-tab" onclick="setTaskFilter('tomorrow')" data-filter="tomorrow">Tomorrow <span class="tab-count" id="fc-tomorrow">0</span></button>
        <button class="filter-tab" onclick="setTaskFilter('week')" data-filter="week">This Week <span class="tab-count" id="fc-week">0</span></button>
        <button class="filter-tab" onclick="setTaskFilter('overdue')" data-filter="overdue">Overdue <span class="tab-count" id="fc-overdue" style="background:var(--red-faint);color:var(--red);">0</span></button>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openAddTaskModal()" style="flex-shrink:0;">
        <svg class="icon-outline" viewBox="0 0 24 24" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Add Task
      </button>
    </div>

    <div class="card">
      <div class="card-title" id="task-list-title">Active Tasks</div>
      <div id="task-list-active"></div>
    </div>

    <div class="card" style="margin-top:20px;" id="task-done-card">
      <div class="card-title">Completed Tasks</div>
      <div id="task-list-done"></div>
    </div>
  </div>

  <!-- Test Log Page -->
  <div id="page-tests" class="page">
    <div class="page-header">
      <div class="page-subtitle">ASSESSMENT</div>
      <h2>Test Log</h2>
      <p>Record and track your test scores</p>
    </div>

    <div style="margin-bottom:20px;">
      <button class="btn btn-primary" onclick="openAddTestModal()">
        <svg class="icon-outline" viewBox="0 0 24 24" style="width:16px;height:16px;">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Test Result
      </button>
    </div>

    <div class="card">
      <div class="card-title">Test History</div>
      <div id="test-log-container" style="overflow-x:auto;">
        <div class="empty-state">No tests recorded yet.</div>
      </div>
    </div>
  </div>

  <!-- Study Analytics Page -->
  <div id="page-analytics" class="page">
    <div class="page-header">
      <div class="page-subtitle">ANALYSIS</div>
      <h2>Study Analytics</h2>
      <p>Track your study patterns and progress over time</p>
    </div>

    <div class="analytics-summary">
      <div class="summary-stat">
        <div class="summary-value" id="total-hours">0h</div>
        <div class="summary-label">Total Study Time</div>
      </div>
      <div class="summary-stat">
        <div class="summary-value" id="avg-daily">0h</div>
        <div class="summary-label">Daily Average (7d)</div>
      </div>
      <div class="summary-stat">
        <div class="summary-value" id="total-sessions">0</div>
        <div class="summary-label">Total Sessions</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Study Sessions by Day</div>
      <div id="sessions-by-day"></div>
    </div>
  </div>

  <!-- Calendar Page -->
  <div id="page-calendar" class="page">
    <div class="page-header">
      <div class="page-subtitle">CHRONICLE</div>
      <h2>Calendar & Reflections</h2>
      <p>View your daily reflections, tasks, and test scores</p>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="calendar-controls">
          <button class="btn btn-sm btn-ghost" onclick="calPrev()">
            <svg class="icon-outline" viewBox="0 0 24 24" style="width:16px;height:16px;">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <div class="calendar-month" id="cal-month-label">January 2026</div>
          <button class="btn btn-sm btn-ghost" onclick="calNext()">
            <svg class="icon-outline" viewBox="0 0 24 24" style="width:16px;height:16px;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
        <div style="display:flex;gap:16px;margin-top:12px;font-size:.75rem;color:var(--cream-faint);justify-content:center;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:6px;height:6px;background:var(--amber);border-radius:50%;"></div><span>Reflection</span></div>
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:6px;height:6px;background:var(--teal);border-radius:50%;"></div><span>Study</span></div>
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:6px;height:6px;background:var(--purple);border-radius:50%;"></div><span>Event</span></div>
        </div>
        <!-- Upcoming events strip -->
        <div class="events-agenda" id="upcoming-events-strip"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);">
          <div class="card-title" id="selected-date-label" style="margin:0;padding:0;border:none;">Select a date</div>
          <button class="btn btn-sm btn-primary" onclick="openAddEventModal()" id="add-event-btn" style="display:none;">+ Event</button>
        </div>
        <div id="date-details">
          <div class="empty-state">Click a date to view details</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div id="add-event-modal" class="modal-backdrop hidden" onclick="closeIfBackdrop(event,'add-event-modal')">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Event</h3>
        <button class="modal-close" onclick="closeModal('add-event-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div>
            <label>Event Title</label>
            <input type="text" id="event-title" placeholder="e.g. Math Exam">
          </div>
        </div>
        <div class="form-row cols-2">
          <div>
            <label>Date</label>
            <input type="date" id="event-date">
          </div>
          <div>
            <label>Time</label>
            <input type="time" id="event-time">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Reminder</label>
            <select id="event-reminder">
              <option value="0">At time of event</option>
              <option value="5">5 minutes before</option>
              <option value="10">10 minutes before</option>
              <option value="15" selected>15 minutes before</option>
              <option value="30">30 minutes before</option>
              <option value="60">1 hour before</option>
              <option value="1440">1 day before</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Notes</label>
            <textarea id="event-notes" placeholder="Optional notes..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('add-event-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveEvent()">Save Event</button>
      </div>
    </div>
  </div>

  <!-- Study Timer Page -->
  <div id="page-timer" class="page">
    <div class="page-header">
      <div class="page-subtitle">FOCUS</div>
      <h2>Study Timer</h2>
      <p>Track your study sessions with brown noise ambience</p>
    </div>

    <div class="card" style="max-width:700px;margin:0 auto;">
      <div style="display:flex;justify-content:center;gap:12px;margin-bottom:20px;">
        <button class="btn" id="mode-timer-btn" onclick="setTimerMode('timer')">Timer</button>
        <button class="btn" id="mode-stopwatch-btn" onclick="setTimerMode('stopwatch')">Stopwatch</button>
      </div>

      <div class="timer-display" id="timer-display">25:00</div>
      
      <div class="timer-controls" id="timer-mode-controls">
        <button class="btn" onclick="setTimer(25)">25 min</button>
        <button class="btn" onclick="setTimer(45)">45 min</button>
        <button class="btn" onclick="setTimer(60)">60 min</button>
        <button class="btn btn-primary" id="timer-start-btn" onclick="toggleTimer()">Start</button>
        <button class="btn" onclick="resetTimer()">Reset</button>
        <button class="btn btn-ghost" onclick="toggleFullscreen()">
          <svg class="icon-outline" viewBox="0 0 24 24" style="width:16px;height:16px;">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
          </svg>
          Fullscreen
        </button>
      </div>

      <div class="timer-controls hidden" id="stopwatch-mode-controls">
        <button class="btn btn-primary" id="stopwatch-start-btn" onclick="toggleTimer()">Start</button>
        <button class="btn" onclick="resetTimer()">Reset</button>
        <button class="btn" onclick="lapStopwatch()" id="lap-btn" style="display:none;">Lap</button>
        <button class="btn btn-ghost" onclick="toggleFullscreen()">
          <svg class="icon-outline" viewBox="0 0 24 24" style="width:16px;height:16px;">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
          </svg>
          Fullscreen
        </button>
      </div>

      <div id="lap-times" style="margin-top:20px;"></div>

      <div style="margin-top:24px;">
        <label>Subject</label>
        <input type="text" id="timer-subject" placeholder="e.g., Mathematics, Literature">
      </div>

      <!-- Brown Noise Player -->
      <div class="noise-player">
        <div class="noise-header">
          <span class="noise-title">Brown Noise</span>
          <button class="btn btn-sm noise-toggle" id="noise-toggle" onclick="toggleNoise()">
            <span id="noise-status">Off</span>
          </button>
        </div>
        <div class="volume-control">
          <span class="volume-label" id="volume-label">Volume: 50%</span>
          <input type="range" min="0" max="100" value="50" class="volume-slider" id="volume-slider" oninput="updateVolume(this.value)">
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Fullscreen Timer -->
<div class="fullscreen-timer" id="fullscreen-timer">
  <button class="fullscreen-close" onclick="toggleFullscreen()">Exit</button>
  
  <div class="timer-display" id="timer-display-full" style="margin:80px 0 60px;">25:00</div>
  
  <div class="timer-controls" id="timer-mode-controls-full">
    <button class="btn btn-primary" id="timer-start-btn-full" onclick="toggleTimer()">Start</button>
    <button class="btn" onclick="resetTimer()">Reset</button>
  </div>

  <div class="timer-controls hidden" id="stopwatch-mode-controls-full">
    <button class="btn btn-primary" id="stopwatch-start-btn-full" onclick="toggleTimer()">Start</button>
    <button class="btn" onclick="resetTimer()">Reset</button>
    <button class="btn" onclick="lapStopwatch()" id="lap-btn-full" style="display:none;">Lap</button>
  </div>
  <div class="noise-player" style="max-width:500px;width:100%;">
    <div class="noise-header">
      <span class="noise-title">Brown Noise</span>
      <button class="btn btn-sm noise-toggle" onclick="toggleNoise()">
        <span id="noise-status-full">Off</span>
      </button>
    </div>
    <div class="volume-control">
      <span class="volume-label" id="volume-label-full">Volume: 50%</span>
      <input type="range" min="0" max="100" value="50" class="volume-slider" oninput="updateVolume(this.value)">
    </div>
  </div>
</div>

<!-- Add Task Modal -->
<div id="add-task-modal" class="modal-backdrop hidden" onclick="closeIfBackdrop(event, 'add-task-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Task</h3>
      <button class="modal-close" onclick="closeModal('add-task-modal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div>
          <label>Task Title</label>
          <input type="text" id="task-title" placeholder="e.g., Complete essay">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Subject</label>
          <input type="text" id="task-subject" placeholder="e.g., English Literature">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Due Date</label>
          <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;">
            <button type="button" class="btn btn-sm btn-ghost" onclick="setTaskDue(0)" style="font-size:.78rem;">Today</button>
            <button type="button" class="btn btn-sm btn-ghost" onclick="setTaskDue(1)" style="font-size:.78rem;">Tomorrow</button>
            <button type="button" class="btn btn-sm btn-ghost" onclick="setTaskDue(3)" style="font-size:.78rem;">In 3 days</button>
            <button type="button" class="btn btn-sm btn-ghost" onclick="setTaskDue(7)" style="font-size:.78rem;">Next week</button>
            <button type="button" class="btn btn-sm btn-ghost" onclick="setTaskDue(null)" style="font-size:.78rem;">No date</button>
          </div>
          <input type="date" id="task-due">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Priority</label>
          <select id="task-priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Notes</label>
          <textarea id="task-notes" placeholder="Additional details..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('add-task-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- Add Test Modal -->
<div id="add-test-modal" class="modal-backdrop hidden" onclick="closeIfBackdrop(event, 'add-test-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Test Result</h3>
      <button class="modal-close" onclick="closeModal('add-test-modal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div>
          <label>Test Title</label>
          <input type="text" id="test-title" placeholder="e.g., Midterm Exam">
        </div>
      </div>
      <div class="form-row cols-2">
        <div>
          <label>Subject</label>
          <input type="text" id="test-subject" placeholder="e.g., Mathematics">
        </div>
        <div>
          <label>Test Date</label>
          <input type="date" id="test-date">
        </div>
      </div>
      <div class="form-row cols-2">
        <div>
          <label>Score Obtained</label>
          <input type="number" id="test-score" placeholder="85">
        </div>
        <div>
          <label>Total Marks</label>
          <input type="number" id="test-total" placeholder="100">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('add-test-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTest()">Save Test</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Sync Status Indicator -->
<div id="sync-status" class="sync-status">
  <div class="sync-dot"></div>
  <span id="sync-text">Offline</span>
</div>

<!-- Auth Overlay (shown when not logged in) -->
<div id="auth-overlay" class="auth-overlay hidden">
  <div class="auth-card">
    <h1 class="auth-title">Scholarium</h1>
    <p class="auth-subtitle">Sign in to sync your academic data across devices</p>
    <button class="btn btn-primary" onclick="signInWithGoogle()" style="width:100%;margin-bottom:12px;">
      <svg viewBox="0 0 24 24" style="width:18px;height:18px;margin-right:8px;">
        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Sign in with Google
    </button>
    <button class="btn btn-ghost" onclick="continueOffline()" style="width:100%;">
      Continue Offline (No Sync)
    </button>
  </div>
</div>

<script>
// ================================================================
//  FIREBASE CONFIGURATION
// ================================================================
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBzEPGBMB4hNsqj3fIYsPTXd_u0uEB0_tc",
  authDomain: "scholarium-eba83.firebaseapp.com",
  projectId: "scholarium-eba83",
  databaseURL: "https://scholarium-eba83-default-rtdb.firebaseio.com",
  storageBucket: "scholarium-eba83.firebasestorage.app",
  messagingSenderId: "1001998768351",
  appId: "1:1001998768351:web:c645426c2fd574b1d4b16a",
  measurementId: "G-KH46EK1VDN"
};

// Initialize Firebase (will be skipped if config is not set)
let firebaseApp = null;
let auth = null;
let db = null;
let currentUser = null;
let syncEnabled = false;

function initFirebase() {
  // Check if config is set
  if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY_HERE") {
    console.log("Firebase not configured - running in offline mode");
    continueOffline();
    return;
  }
  
  try {
    firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
    auth = firebase.auth();
    db = firebase.database();
    
    // Auth state listener
    auth.onAuthStateChanged(user => {
      _dbg('auth: ' + (user ? user.email : 'signed out'));
      if (user) {
        currentUser = user;
        syncEnabled = true;
        hideAuthOverlay();
        updateSyncStatus('synced', 'Synced');
        
        // Show user info in sidebar
        const userSection = document.getElementById('user-section');
        const userName = document.getElementById('user-display-name');
        if (userSection && userName) {
          userName.textContent = user.displayName || user.email;
          userSection.classList.remove('hidden');
        }
        // Update drawer auth state
        const drawerSignin = document.getElementById('drawer-signin-btn');
        const drawerSignout = document.getElementById('drawer-signout-btn');
        if(drawerSignin) drawerSignin.style.display = 'none';
        if(drawerSignout) drawerSignout.style.display = '';
        
        // Flush any writes queued before auth resolved
        flushDirtyKeys();
        // Merge cloud into local, push merged, then start live listeners
        syncFromCloud().then(() => setupSyncListeners());
      } else {
        currentUser = null;
        syncEnabled = false;
        
        // Hide user info
        const userSection = document.getElementById('user-section');
        if (userSection) userSection.classList.add('hidden');
        
        showAuthOverlay();
      }
    });
  } catch (error) {
    console.error("Firebase initialization error:", error);
    continueOffline();
  }
}

function showAuthOverlay() {
  document.getElementById('auth-overlay').classList.remove('hidden');
}

function hideAuthOverlay() {
  document.getElementById('auth-overlay').classList.add('hidden');
}

function continueOffline() {
  hideAuthOverlay();
  syncEnabled = false;
  updateSyncStatus('offline', 'Offline Mode');
  setTimeout(() => {
    document.getElementById('sync-status').classList.remove('show');
  }, 3000);
}

function toggleDrawer() {
  const drawer = document.getElementById('mobile-drawer');
  const backdrop = document.getElementById('mobile-drawer-backdrop');
  const isOpen = drawer.classList.contains('open');
  drawer.style.display = isOpen ? 'none' : 'block';
  backdrop.style.display = isOpen ? 'none' : 'block';
  // tiny delay so display:block is applied before transition
  if(!isOpen) { requestAnimationFrame(() => { drawer.classList.add('open'); }); }
  else { drawer.classList.remove('open'); }
}
function closeDrawer() {
  const drawer = document.getElementById('mobile-drawer');
  const backdrop = document.getElementById('mobile-drawer-backdrop');
  drawer.classList.remove('open');
  backdrop.style.display = 'none';
  setTimeout(() => { drawer.style.display = 'none'; }, 300);
}
// Keep old name as alias in case anything still calls it
function toggleMobileMenu() { toggleDrawer(); }

async function signInWithGoogle() {
  if (!auth) {
    toast('Firebase not configured');
    return;
  }
  
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    const result = await auth.signInWithPopup(provider);
    if (result.user) {
      toast('Signed in successfully!');
    }
  } catch (error) {
    console.error("Sign in error:", error);
    toast('Sign in failed: ' + (error.message || 'Unknown error'));
    continueOffline();
  }
}

async function signOut() {
  if (!auth) return;
  
  try {
    await auth.signOut();
    toast('Signed out');
    showAuthOverlay();
  } catch (error) {
    console.error("Sign out error:", error);
    toast('Sign out failed');
  }
}

let _syncHideTimer = null;
function updateSyncStatus(status, text) {
  const statusEl = document.getElementById('sync-status');
  if(!statusEl) return;
  const textEl = document.getElementById('sync-text');
  const dotEl = statusEl.querySelector('.sync-dot');

  statusEl.classList.remove('syncing', 'synced', 'error', 'offline');
  if(dotEl) dotEl.classList.remove('pulse');
  clearTimeout(_syncHideTimer);

  if(status === 'syncing') {
    statusEl.classList.add('syncing', 'show');
    if(dotEl) dotEl.classList.add('pulse');
  } else if(status === 'synced') {
    statusEl.classList.add('synced', 'show');
    _syncHideTimer = setTimeout(() => statusEl.classList.remove('show'), 2500);
  } else if(status === 'error') {
    statusEl.classList.add('error', 'show');
    // errors stay visible until next sync attempt
  } else {
    _syncHideTimer = setTimeout(() => statusEl.classList.remove('show'), 3000);
  }

  if(textEl) textEl.textContent = text;

  // Update drawer auth buttons
  const drawerSignin = document.getElementById('drawer-signin-btn');
  const drawerSignout = document.getElementById('drawer-signout-btn');
  if(drawerSignin && drawerSignout) {
    if(currentUser) {
      drawerSignin.style.display = 'none';
      drawerSignout.style.display = '';
    } else {
      drawerSignin.style.display = '';
      drawerSignout.style.display = 'none';
    }
  }
}

// ================================================================
//  DATABASE (localStorage)
// ================================================================
const COLLECTIONS = ['tasks', 'tests', 'journals', 'study-sessions', 'events'];
COLLECTIONS.forEach(k => { if(!localStorage.getItem(k)) localStorage.setItem(k,'[]'); });

const DB = {
  get:    k => { try{ return JSON.parse(localStorage.getItem(k))||[]; }catch{return[];} },
  getRaw: k => { try{ return JSON.parse(localStorage.getItem(k))||[]; }catch{return[];} },
  set:    (k,v) => localWrite(k,v)
};

// ================================================================
//  SYNC ENGINE ‚Äî Firebase Realtime Database
// ================================================================
let _dirty   = new Set();
let _pushing = false;
let _liveOff = null;   // unsubscribe handle for live listener

// ‚îÄ‚îÄ Debug ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _dbg(msg) {
  console.log('[sync]', msg);
  const el = document.getElementById('sync-debug-log');
  if(!el) return;
  const d = document.createElement('div');
  d.textContent = new Date().toLocaleTimeString()+' '+msg;
  d.style.cssText = 'font-size:11px;padding:2px 0;border-bottom:1px solid #333;color:#c4b39a;';
  el.insertBefore(d, el.firstChild);
  while(el.children.length > 14) el.removeChild(el.lastChild);
  const panel = document.getElementById('sync-debug-panel');
  if(panel && panel.style.display !== 'none') _updateDebugState();
}

// ‚îÄ‚îÄ Every write goes here ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function localWrite(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
  if(!currentUser || !db) return; // offline ‚Äî data safe in localStorage
  _dirty.add(key);
  clearTimeout(_pushTimer);
  _pushTimer = setTimeout(_push, 400);
}
let _pushTimer = null;

// ‚îÄ‚îÄ Push one key at a time to avoid race conditions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _push() {
  if(_pushing || !currentUser || !db) return;
  if(_dirty.size === 0) return;

  const col = Array.from(_dirty)[0]; // take first dirty key
  _dirty.delete(col);
  _pushing = true;

  const data = DB.getRaw(col);
  _dbg('write '+col+' ('+data.length+')');
  updateSyncStatus('syncing','Saving...');

  db.ref('users/'+currentUser.uid+'/'+col).set(data)
    .then(() => {
      _dbg(col+' ‚úì');
      _pushing = false;
      if(_dirty.size > 0) setTimeout(_push, 100); // push next key
      else { updateSyncStatus('synced','Saved ‚úì'); _dbg('all done ‚úì'); }
    })
    .catch(err => {
      _dbg('FAIL '+col+': '+(err.code||err.message));
      _dirty.add(col); // re-queue
      _pushing = false;
      updateSyncStatus('error','Save failed ‚Äî retrying in 5s');
      setTimeout(_push, 5000);
    });
}

// ‚îÄ‚îÄ On login: load cloud, merge with local, push back ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncFromCloud() {
  if(!currentUser || !db) return Promise.resolve();
  updateSyncStatus('syncing','Loading...');
  _dbg('reading cloud...');

  return new Promise(resolve => {
    const uid = currentUser.uid;
    const timeout = setTimeout(() => {
      _dbg('cloud read timed out ‚Äî using local data');
      updateSyncStatus('error','Load timed out');
      resolve();
    }, 8000);

    db.ref('users/'+uid).once('value')
      .then(snap => {
        clearTimeout(timeout);
        const cloud = snap.val() || {};
        _dbg('cloud data: '+JSON.stringify(Object.keys(cloud)));

        COLLECTIONS.forEach(col => {
          const cloudRaw = cloud[col];
          if(!cloudRaw) { _dbg('no cloud data for '+col); return; }
          // RTDB arrays can come back as objects with numeric keys
          const cloudArr = Array.isArray(cloudRaw)
            ? cloudRaw.filter(Boolean)
            : Object.values(cloudRaw).filter(Boolean);
          const local = DB.getRaw(col);
          // Merge ‚Äî local wins on same id
          const map = new Map();
          cloudArr.forEach(x => x.id && map.set(x.id, x));
          local.forEach(x => x.id && map.set(x.id, x));
          const merged = [...map.values()];
          localStorage.setItem(col, JSON.stringify(merged));
          _dbg('merged '+col+': cloud='+cloudArr.length+' local='+local.length+' result='+merged.length);
        });

        refreshAllViews();
        updateSyncStatus('synced','Up to date');
        // Push merged result back to cloud
        COLLECTIONS.forEach(k => _dirty.add(k));
        _push();
        resolve();
      })
      .catch(err => {
        clearTimeout(timeout);
        _dbg('cloud read FAILED: '+(err.code||err.message));
        updateSyncStatus('error','Load failed: '+(err.code||'unknown'));
        resolve(); // don't block ‚Äî app still works with local data
      });
  });
}

// ‚îÄ‚îÄ Flush writes queued before auth was ready ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function flushDirtyKeys() {
  _dbg('flush dirty=['+ Array.from(_dirty).join(',')+']');
  if(_dirty.size > 0) _push();
}

// ‚îÄ‚îÄ Live listener ‚Äî updates from another device ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupSyncListeners() {
  if(!currentUser || !db) return;
  if(_liveOff) { db.ref('users/'+currentUser.uid).off('value', _liveOff); }

  const uid = currentUser.uid;
  let first = true;
  _liveOff = db.ref('users/'+uid).on('value', snap => {
    if(first) { first = false; return; } // skip initial echo
    if(_pushing || _dirty.size > 0) return; // we're writing, ignore
    const cloud = snap.val() || {};
    let changed = false;
    COLLECTIONS.forEach(col => {
      const cloudRaw = cloud[col];
      if(!cloudRaw) return;
      const cloudArr = Array.isArray(cloudRaw)
        ? cloudRaw.filter(Boolean)
        : Object.values(cloudRaw).filter(Boolean);
      const local = JSON.stringify(DB.getRaw(col));
      const cloudStr = JSON.stringify(cloudArr);
      if(local !== cloudStr) {
        localStorage.setItem(col, cloudStr);
        changed = true;
      }
    });
    if(changed) { refreshAllViews(); _dbg('live update applied'); }
  });
}

// ‚îÄ‚îÄ Manual force sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncToCloud() {
  COLLECTIONS.forEach(k => _dirty.add(k));
  _push();
}

// ‚îÄ‚îÄ Refresh all views ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function refreshAllViews() {
  renderDashboard();
  renderTasks();
  renderTests();
  renderAnalytics();
  renderCalendar();
}

function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function formatDate(ds) {
  if(!ds) return '‚Äî';
  const d = new Date(ds+'T00:00:00');
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
}

function daysFromNow(ds) {
  const target = new Date(ds+'T00:00:00');
  const now = new Date(); now.setHours(0,0,0,0);
  return Math.floor((target - now) / (1000*60*60*24));
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 2500);
}

function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  
  // Update desktop nav
  const desktopNav = Array.from(document.querySelectorAll('.nav-item')).find(
    n => n.getAttribute('onclick')?.includes(page)
  );
  if(desktopNav) desktopNav.classList.add('active');
  
  // Update mobile nav
  const mobileNav = Array.from(document.querySelectorAll('.mobile-nav-item')).find(
    n => n.getAttribute('onclick')?.includes(page)
  );
  if(mobileNav) mobileNav.classList.add('active');
  
  if(page==='dashboard') renderDashboard();
  if(page==='tasks') renderTasks();
  if(page==='tests') renderTests();
  if(page==='analytics') renderAnalytics();
  if(page==='calendar') {
    // Sync from cloud first so calendar shows latest data
    if(syncEnabled && currentUser) {
      syncFromCloud().then(() => renderCalendar());
    } else {
      renderCalendar();
    }
  }
}

function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
}

function closeIfBackdrop(e, id) {
  if(e.target.classList.contains('modal-backdrop')) closeModal(id);
}

// Clock
let _clockTaps = 0, _clockTapTimer = null;
function showSyncDebug() {
  const panel = document.getElementById('sync-debug-panel');
  if(panel) { panel.style.display = 'block'; _updateDebugState(); }
}
function tapClock() {
  _clockTaps++;
  clearTimeout(_clockTapTimer);
  _clockTapTimer = setTimeout(() => { _clockTaps = 0; }, 1500);
  if(_clockTaps >= 3) {
    _clockTaps = 0;
    const panel = document.getElementById('sync-debug-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    _updateDebugState();
  }
}
function _updateDebugState() {
  const el = document.getElementById('sync-debug-state');
  if(!el) return;
  el.textContent = [
    'user: ' + (currentUser ? currentUser.email : 'NULL ‚ö†Ô∏è'),
    'db: ' + (db ? 'RTDB OK' : 'NULL ‚ö†Ô∏è'),
    'dirty: [' + Array.from(_dirty).join(',') + ']',
    'pushing: ' + _pushing,
    'tasks: ' + DB.getRaw('tasks').length
  ].join(' | ');
}
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;
  document.getElementById('year').textContent = now.getFullYear();
}
setInterval(updateClock, 1000);
updateClock();

// Theme toggle
function toggleTheme() {
  const body = document.body;
  const isOxblood = body.classList.contains('theme-oxblood');
  
  if(isOxblood) {
    body.classList.remove('theme-oxblood');
    document.getElementById('theme-label').textContent = 'Oxblood Theme';
    const mobileLabel = document.getElementById('theme-label-mobile');
    if(mobileLabel) mobileLabel.textContent = 'Switch to Oxblood Theme';
    localStorage.setItem('theme', 'default');
  } else {
    body.classList.add('theme-oxblood');
    document.getElementById('theme-label').textContent = 'Default Theme';
    const mobileLabel = document.getElementById('theme-label-mobile');
    if(mobileLabel) mobileLabel.textContent = 'Switch to Default Theme';
    localStorage.setItem('theme', 'oxblood');
  }
}

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if(savedTheme === 'oxblood') {
  document.body.classList.add('theme-oxblood');
  document.getElementById('theme-label').textContent = 'Default Theme';
  setTimeout(() => {
    const mobileLabel = document.getElementById('theme-label-mobile');
    if(mobileLabel) mobileLabel.textContent = 'Switch to Default Theme';
  }, 100);
}

// ================================================================
//  DASHBOARD
// ================================================================
let dashMood = '';
function setDashMood(m) {
  dashMood = dashMood===m ? '' : m;
  document.querySelectorAll('#dash-mood-row .mood-btn').forEach(b => {
    b.classList.toggle('active', b.textContent===dashMood);
  });
}

function saveDashJournal() {
  const text = document.getElementById('dash-journal-text').value.trim();
  const ds = todayStr();
  let list = DB.get('journals');
  const idx = list.findIndex(j=>j.date===ds);
  const entry = {date:ds, text, mood:dashMood, updated:Date.now()};
  if(idx>=0) list[idx]=entry; 
  else if(text||dashMood) list.push(entry);
  localWrite('journals', list);
  toast('Reflection saved');
  renderCalendar();
}

function calcStreak() {
  const sessions = DB.get('study-sessions');
  const sessionDates = new Set(sessions.map(s => s.date));
  let streak = 0;
  const d = new Date();
  // Check today first; if no session today start from yesterday
  if(!sessionDates.has(todayStr())) d.setDate(d.getDate()-1);
  while(true) {
    const ds = d.toISOString().split('T')[0];
    if(!sessionDates.has(ds)) break;
    streak++;
    d.setDate(d.getDate()-1);
  }
  return streak;
}

function renderDashboard() {
  const h = new Date().getHours();
  const g = h<12 ? 'Good Morning' : h<17 ? 'Good Afternoon' : 'Good Evening';
  document.getElementById('dash-greeting').textContent = g;
  document.getElementById('dash-date-full').textContent =
    new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});

  const allTasks = DB.get('tasks');
  const today = todayStr();

  // Stats
  const active = allTasks.filter(t=>t.status!=='done');
  const dueSoon = active.filter(t=>{ if(!t.due) return false; const d=daysFromNow(t.due); return d>=0&&d<=3; });
  document.getElementById('s-tasks-due').textContent = dueSoon.length;
  document.getElementById('s-done').textContent = allTasks.filter(t=>t.status==='done').length;
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
  const sessions = DB.get('study-sessions').filter(s=>new Date(s.date)>=weekAgo);
  const weekMins = sessions.reduce((a,s)=>a+s.duration,0);
  document.getElementById('s-study').textContent = weekMins>=60?Math.floor(weekMins/60)+'h':weekMins+'m';

  // Streak badge
  const streak = calcStreak();
  const streakWrap = document.getElementById('streak-badge-wrap');
  if(streakWrap) {
    streakWrap.innerHTML = streak > 0
      ? `<span class="streak-badge">üî• ${streak} day${streak>1?'s':''} streak</span>`
      : '';
  }

  // Today's agenda ‚Äî tasks due today + events today, sorted by time
  const todayTasks = active.filter(t=>t.due===today);
  const todayEvents = DB.get('events').filter(e=>e.date===today).sort((a,b)=>a.time.localeCompare(b.time));
  const agendaEl = document.getElementById('dash-agenda');
  if(agendaEl) {
    let items = [];
    todayEvents.forEach(ev => {
      const timeStr = ev.time && ev.time!=='00:00'
        ? new Date('2000-01-01T'+ev.time).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})
        : '';
      items.push(`<div class="agenda-item">
        <div class="agenda-time">${timeStr||'‚Äî'}</div>
        <div class="agenda-dot" style="background:var(--purple);"></div>
        <div class="agenda-content">
          <div class="agenda-title">${ev.title}</div>
          ${ev.notes?`<div class="agenda-sub">${ev.notes}</div>`:''}
        </div>
      </div>`);
    });
    todayTasks.forEach(t => {
      const overdue = t.due < today;
      items.push(`<div class="agenda-item">
        <div class="agenda-time" style="color:var(--cream-faint);">task</div>
        <div class="agenda-dot" style="background:${overdue?'var(--red)':'var(--amber)'};"></div>
        <div class="agenda-content">
          <div class="agenda-title">${t.title}</div>
          <div class="agenda-sub">${t.subject||'General'}</div>
        </div>
        <input type="checkbox" ${t.status==='done'?'checked':''} onchange="quickDone('${t.id}',this.checked)" style="margin-left:8px;">
      </div>`);
    });
    agendaEl.innerHTML = items.length ? items.join('') : '<div class="empty-state" style="padding:20px 0;">Nothing scheduled for today ‚Äî enjoy your day!</div>';
  }

  // Upcoming tasks (next 5)
  const upcoming = active.sort((a,b)=>(a.due||'9999')>(b.due||'9999')?1:-1).slice(0,5);
  const taskContainer = document.getElementById('dash-upcoming-tasks');
  if(!upcoming.length) {
    taskContainer.innerHTML = '<div class="empty-state">No pending tasks</div>';
  } else {
    taskContainer.innerHTML = upcoming.map(t => {
      const diff = t.due ? daysFromNow(t.due) : null;
      let dueColor = 'var(--cream-faint)';
      if(diff!==null){ if(diff<0) dueColor='var(--red)'; else if(diff<=2) dueColor='var(--amber)'; }
      const diffLabel = diff===null?'No date':diff===0?'Today':diff===1?'Tomorrow':diff<0?`${Math.abs(diff)}d overdue`:`In ${diff}d`;
      return `<div class="task-item">
        <input type="checkbox" onchange="quickDone('${t.id}',this.checked)">
        <div class="task-content">
          <div class="task-title">${t.title}</div>
          <div class="task-meta">${t.subject||'General'} ‚Ä¢ <span style="color:${dueColor}">${diffLabel}</span></div>
        </div>
      </div>`;
    }).join('');
  }

  // Today's journal
  const entry = DB.get('journals').find(j=>j.date===today);
  if(entry) {
    document.getElementById('dash-journal-text').value = entry.text||'';
    dashMood = entry.mood||'';
    document.querySelectorAll('#dash-mood-row .mood-btn').forEach(b=>b.classList.toggle('active',b.textContent===dashMood));
  } else {
    document.getElementById('dash-journal-text').value = '';
    dashMood = '';
    document.querySelectorAll('#dash-mood-row .mood-btn').forEach(b=>b.classList.remove('active'));
  }
}

function quickDone(id, checked) {
  const list = DB.get('tasks');
  const t = list.find(x=>x.id===id); 
  if(!t) return;
  t.status = checked ? 'done' : 'todo';
  localWrite('tasks', list);
  renderDashboard();
}

// ================================================================
//  TASK MANAGER
// ================================================================
let currentTaskFilter = 'all';

function updateFilterCounts() {
  const allTasks = DB.get('tasks');
  const active = allTasks.filter(t=>t.status!=='done');
  const today = todayStr();
  const tomorrow = (()=>{const d=new Date();d.setDate(d.getDate()+1);return d.toISOString().split('T')[0];})();
  const weekEnd = (()=>{const d=new Date();d.setDate(d.getDate()+7);return d.toISOString().split('T')[0];})();
  const counts = {
    all: active.length,
    today: active.filter(t=>t.due===today).length,
    tomorrow: active.filter(t=>t.due===tomorrow).length,
    week: active.filter(t=>t.due&&t.due>=today&&t.due<=weekEnd).length,
    overdue: active.filter(t=>t.due&&t.due<today).length
  };
  Object.keys(counts).forEach(k=>{
    const el = document.getElementById('fc-'+k);
    if(el) el.textContent = counts[k];
  });
}

function setTaskFilter(filter) {
  currentTaskFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(b => {
    b.classList.toggle('active', b.dataset.filter === filter);
  });
  const titles = {all:'Active Tasks', today:"Today's Tasks", tomorrow:"Tomorrow's Tasks", week:'This Week', overdue:'Overdue Tasks'};
  const titleEl = document.getElementById('task-list-title');
  if(titleEl) titleEl.textContent = titles[filter] || 'Active Tasks';
  const doneCard = document.getElementById('task-done-card');
  if(doneCard) doneCard.style.display = filter === 'all' ? '' : 'none';
  renderTasks();
}

function setTaskDue(daysFromToday) {
  if(daysFromToday === null) {
    document.getElementById('task-due').value = '';
    return;
  }
  const d = new Date();
  d.setDate(d.getDate() + daysFromToday);
  document.getElementById('task-due').value = d.toISOString().split('T')[0];
}

function openAddTaskModal(preDate) {
  document.getElementById('task-title').value = '';
  document.getElementById('task-subject').value = '';
  document.getElementById('task-priority').value = 'medium';
  document.getElementById('task-notes').value = '';
  document.getElementById('task-subject').value = '';

  // Smart default date based on active filter
  if(preDate) {
    document.getElementById('task-due').value = preDate;
  } else if(currentTaskFilter === 'tomorrow') {
    setTaskDue(1);
  } else if(currentTaskFilter === 'week') {
    setTaskDue(3);
  } else if(currentTaskFilter === 'overdue' || currentTaskFilter === 'today') {
    setTaskDue(0);
  } else {
    setTaskDue(0); // default to today for 'all'
  }

  document.getElementById('add-task-modal').classList.remove('hidden');
  // Focus title field
  setTimeout(() => document.getElementById('task-title').focus(), 100);
}

function saveTask() {
  const title = document.getElementById('task-title').value.trim();
  if(!title) { toast('Please enter a task title'); return; }
  
  const task = {
    id: generateId(),
    title,
    subject: document.getElementById('task-subject').value.trim(),
    due: document.getElementById('task-due').value,
    priority: document.getElementById('task-priority').value,
    notes: document.getElementById('task-notes').value.trim(),
    status: 'todo',
    created: Date.now()
  };
  
  const list = DB.get('tasks');
  list.push(task);
  localWrite('tasks', list);
  closeModal('add-task-modal');
  
  // Show a friendly confirmation with the date
  const today = todayStr();
  const tomorrow = (() => { const d = new Date(); d.setDate(d.getDate()+1); return d.toISOString().split('T')[0]; })();
  let dateLabel = task.due ? (
    task.due === today ? 'due today' :
    task.due === tomorrow ? 'due tomorrow' :
    'due ' + formatDate(task.due)
  ) : 'no due date';
  toast(`Task added ‚Äî ${dateLabel}`);

  // Always switch to 'all' so the task is guaranteed to be visible
  setTaskFilter('all');
  renderDashboard();
}

function renderTasks() {
  const allTasks = DB.get('tasks');
  const today = todayStr();
  const tomorrow = (() => { const d = new Date(); d.setDate(d.getDate()+1); return d.toISOString().split('T')[0]; })();
  const weekEnd = (() => { const d = new Date(); d.setDate(d.getDate()+7); return d.toISOString().split('T')[0]; })();
  
  const filter = currentTaskFilter || 'all';
  let active = allTasks.filter(t => t.status !== 'done');
  
  // Apply filter
  if(filter === 'today') active = active.filter(t => t.due === today);
  else if(filter === 'tomorrow') active = active.filter(t => t.due === tomorrow);
  else if(filter === 'week') active = active.filter(t => t.due && t.due >= today && t.due <= weekEnd);
  // 'all' shows everything including tasks with no due date
  else if(filter === 'overdue') active = active.filter(t => t.due && t.due < today);
  
  active = active.sort((a,b) => (a.due||'9999') > (b.due||'9999') ? 1 : -1);
  
  const activeEl = document.getElementById('task-list-active');
  
  if(!active.length) {
    const emptyMsgs = {
      all: 'No active tasks ‚Äî add one above!',
      today: 'No tasks due today',
      tomorrow: 'No tasks due tomorrow',
      week: 'No tasks due this week',
      overdue: 'No overdue tasks üéâ'
    };
    activeEl.innerHTML = `<div class="empty-state">${emptyMsgs[filter]||'No tasks'}</div>`;
  } else {
    // Group by date
    const groups = {};
    active.forEach(t => {
      const key = t.due || 'no-date';
      if(!groups[key]) groups[key] = [];
      groups[key].push(t);
    });
    
    const sortedKeys = Object.keys(groups).sort((a,b) => a > b ? 1 : -1);
    
    activeEl.innerHTML = sortedKeys.map(key => {
      const label = key === 'no-date' ? 'No Due Date' : (() => {
        const diff = daysFromNow(key);
        if(diff === 0) return 'üìå Today';
        if(diff === 1) return 'üìÖ Tomorrow';
        if(diff < 0) return `‚ö†Ô∏è Overdue (${formatDate(key)})`;
        if(diff <= 7) return `üìÜ ${new Date(key+'T00:00:00').toLocaleDateString('en-US',{weekday:'long'})} ‚Äî ${formatDate(key)}`;
        return `üìÜ ${formatDate(key)}`;
      })();
      
      const groupTasks = groups[key].map(t => {
        const diff = t.due ? daysFromNow(t.due) : null;
        let dueColor = 'var(--cream-faint)';
        if(diff !== null) {
          if(diff < 0) dueColor = 'var(--red)';
          else if(diff <= 2) dueColor = 'var(--amber)';
        }
        const priorityBadge = t.priority==='high' 
          ? '<span style="color:var(--red);font-size:.78rem;margin-left:6px;">‚¨Ü High</span>' 
          : t.priority==='medium' ? '' : '<span style="color:var(--cream-faint);font-size:.78rem;margin-left:6px;">Low</span>';
        return `<div class="task-item">
          <input type="checkbox" onchange="toggleTaskStatus('${t.id}')">
          <div class="task-content">
            <div class="task-title">${t.title}${priorityBadge}</div>
            <div class="task-meta">${t.subject||'General'}${t.notes ? ' ‚Ä¢ '+t.notes.substring(0,40)+(t.notes.length>40?'‚Ä¶':'') : ''}</div>
          </div>
          <div class="task-actions">
            <button class="btn btn-sm btn-danger" onclick="deleteTask('${t.id}')">‚úï</button>
          </div>
        </div>`;
      }).join('');
      
      return `<div style="margin-bottom:16px;">
        <div style="font-size:.78rem;font-family:var(--font-mono);color:var(--amber);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border);">${label}</div>
        ${groupTasks}
      </div>`;
    }).join('');
  }
  
  // Update count badges on filter tabs
  updateFilterCounts();

  // Done tasks (only show in 'all' filter)
  const doneEl = document.getElementById('task-list-done');
  if(doneEl) {
    const done = allTasks.filter(t=>t.status==='done').sort((a,b)=>b.created-a.created);
    if(!done.length) {
      doneEl.innerHTML = '<div class="empty-state">No completed tasks yet</div>';
    } else {
      doneEl.innerHTML = done.map(t => `<div class="task-item task-done">
        <input type="checkbox" checked onchange="toggleTaskStatus('${t.id}')">
        <div class="task-content">
          <div class="task-title">${t.title}</div>
          <div class="task-meta">${t.subject||'General'}</div>
        </div>
        <div class="task-actions">
          <button class="btn btn-sm btn-danger" onclick="deleteTask('${t.id}')">‚úï</button>
        </div>
      </div>`).join('');
    }
  }
}

function toggleTaskStatus(id) {
  const list = DB.get('tasks');
  const t = list.find(x=>x.id===id);
  if(!t) return;
  t.status = t.status==='done' ? 'todo' : 'done';
  t.completedAt = t.status==='done' ? Date.now() : null;
  localWrite('tasks', list);
  renderTasks();
  renderDashboard();
}

function deleteTask(id) {
  const updated = DB.get('tasks').filter(t => t.id !== id);
  localWrite('tasks', updated);
  toast('Task deleted');
  renderTasks();
  renderDashboard();
}

// ================================================================
//  TEST LOG
// ================================================================
function openAddTestModal() {
  document.getElementById('test-title').value = '';
  document.getElementById('test-subject').value = '';
  document.getElementById('test-date').value = todayStr();
  document.getElementById('test-score').value = '';
  document.getElementById('test-total').value = '';
  document.getElementById('add-test-modal').classList.remove('hidden');
}

function saveTest() {
  const title = document.getElementById('test-title').value.trim();
  const score = parseInt(document.getElementById('test-score').value);
  const total = parseInt(document.getElementById('test-total').value);
  
  if(!title || isNaN(score) || isNaN(total)) {
    toast('Please fill all fields correctly');
    return;
  }
  
  const test = {
    id: generateId(),
    title,
    subject: document.getElementById('test-subject').value.trim(),
    date: document.getElementById('test-date').value,
    score,
    total,
    created: Date.now()
  };
  
  const list = DB.get('tests');
  list.push(test);
  localWrite('tests', list);
  closeModal('add-test-modal');
  toast('Test recorded');
  renderTests();
  renderDashboard();
}

function renderTests() {
  const tests = DB.get('tests').sort((a,b)=>b.date.localeCompare(a.date));
  const container = document.getElementById('test-log-container');
  
  if(!tests.length) {
    container.innerHTML = '<div class="empty-state">No tests recorded yet</div>';
    return;
  }
  
  container.innerHTML = `
    <table class="test-table">
      <thead>
        <tr>
          <th>Test Title</th>
          <th>Subject</th>
          <th>Date</th>
          <th>Score</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${tests.map(t => {
          const percentage = Math.round((t.score/t.total)*100);
          let scoreColor = 'var(--amber-glow)';
          if(percentage<60) scoreColor='#d86058';
          else if(percentage>=85) scoreColor='var(--green)';
          
          return `<tr>
            <td>${t.title}</td>
            <td>${t.subject||'‚Äî'}</td>
            <td>${formatDate(t.date)}</td>
            <td>
              <span class="test-score" style="color:${scoreColor}">${t.score}/${t.total}</span>
              <span class="test-percentage">(${percentage}%)</span>
            </td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteTest('${t.id}')">Delete</button>
            </td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  `;
}

function deleteTest(id) {
  const updated = DB.get('tests').filter(t => t.id !== id);
  localWrite('tests', updated);
  toast('Test deleted');
  renderTests();
  renderDashboard();
}

// ================================================================
//  CALENDAR
// ================================================================
let calViewDate = new Date();
let selectedDate = null;

function renderCalendar() {
  const y = calViewDate.getFullYear();
  const m = calViewDate.getMonth();
  
  document.getElementById('cal-month-label').textContent = 
    new Date(y,m,1).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  
  const first = new Date(y,m,1).getDay();
  const days = new Date(y,m+1,0).getDate();
  const today = todayStr();
  
  const journals = DB.get('journals');
  const sessions = DB.get('study-sessions');
  const events = DB.get('events');
  const hasEntry = {};
  const hasStudy = {};
  const hasEvent = {};
  journals.forEach(j => hasEntry[j.date] = true);
  sessions.forEach(s => hasStudy[s.date] = true);
  events.forEach(e => hasEvent[e.date] = true);
  
  const names = ['Su','Mo','Tu','We','Th','Fr','Sa'];
  let html = names.map(n=>`<div class="cal-day-name">${n}</div>`).join('');
  
  for(let i=0; i<first; i++) html += `<div class="cal-day other-month"></div>`;
  
  for(let d=1; d<=days; d++) {
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cls = ['cal-day'];
    if(ds===today) cls.push('today');
    if(ds===selectedDate) cls.push('selected');
    if(hasEntry[ds]) cls.push('has-entry');
    if(hasStudy[ds]) cls.push('has-study');
    if(hasEvent[ds]) cls.push('has-event');
    html += `<div class="${cls.join(' ')}" onclick="selectDate('${ds}')">${d}</div>`;
  }
  
  document.getElementById('cal-grid').innerHTML = html;

  // Render upcoming events strip (next 7 days)
  const eventsStrip = document.getElementById('upcoming-events-strip');
  if(eventsStrip) {
    const today = todayStr();
    const in7 = (()=>{const d=new Date();d.setDate(d.getDate()+7);return d.toISOString().split('T')[0];})();
    const upcoming = DB.get('events')
      .filter(e=>e.date>=today && e.date<=in7)
      .sort((a,b)=>a.date===b.date?a.time.localeCompare(b.time):a.date.localeCompare(b.date));
    if(!upcoming.length) {
      eventsStrip.innerHTML = '';
    } else {
      eventsStrip.innerHTML = '<div class="events-agenda-title">Upcoming Events</div>' +
        upcoming.map(ev => {
          const diff = daysFromNow(ev.date);
          const dateLabel = diff===0?'Today':diff===1?'Tomorrow':new Date(ev.date+'T00:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
          const timeStr = ev.time&&ev.time!=='00:00'?new Date('2000-01-01T'+ev.time).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}):'';
          return `<div class="event-chip" onclick="selectDate('${ev.date}')">
            <span class="event-chip-date">${dateLabel}</span>
            <span class="event-chip-title">${ev.title}</span>
            ${timeStr?`<span class="event-chip-time">${timeStr}</span>`:''}
          </div>`;
        }).join('');
    }
  }
}

function calPrev() {
  calViewDate.setMonth(calViewDate.getMonth()-1);
  renderCalendar();
}

function calNext() {
  calViewDate.setMonth(calViewDate.getMonth()+1);
  renderCalendar();
}

function selectDate(ds) {
  selectedDate = ds;
  renderCalendar();
  
  const label = new Date(ds+'T00:00:00').toLocaleDateString('en-US',{
    weekday:'long', month:'long', day:'numeric', year:'numeric'
  });
  document.getElementById('selected-date-label').textContent = label;
  
  // Show add event button
  const addBtn = document.getElementById('add-event-btn');
  if(addBtn) { addBtn.style.display = 'inline-flex'; addBtn.dataset.date = ds; }
  
  // Get data for this date
  const journal = DB.get('journals').find(j=>j.date===ds);
  const tasks = DB.get('tasks').filter(t=>t.due===ds);
  const tests = DB.get('tests').filter(t=>t.date===ds);
  const sessions = DB.get('study-sessions').filter(s=>s.date===ds);
  const events = DB.get('events').filter(e=>e.date===ds).sort((a,b)=>a.time.localeCompare(b.time));
  
  let html = '';
  
  // Events
  if(events.length) {
    html += `<div class="reflection-card" style="border-left:3px solid var(--purple);">
      <div class="reflection-date" style="color:var(--purple);">Events</div>`;
    events.forEach(ev => {
      const timeStr = ev.time ? new Date('2000-01-01T'+ev.time).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}) : '';
      html += `<div style="margin:8px 0;padding:8px;background:var(--bg-base);border-radius:var(--radius);display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <strong style="color:var(--cream);">${ev.title}</strong>
          ${timeStr ? `<div style="color:var(--purple);font-family:var(--font-mono);font-size:.8rem;margin-top:2px;">${timeStr}</div>` : ''}
          ${ev.notes ? `<div style="color:var(--cream-faint);font-size:.85rem;margin-top:4px;">${ev.notes}</div>` : ''}
          <div style="color:var(--cream-faint);font-size:.75rem;margin-top:4px;">üîî ${ev.reminderLabel}</div>
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteEvent('${ev.id}')" style="margin-left:8px;flex-shrink:0;">‚úï</button>
      </div>`;
    });
    html += `</div>`;
  }
  
  // Reflection
  if(journal) {
    html += `<div class="reflection-card">
      <div class="reflection-date">Daily Reflection</div>
      <div class="reflection-text">
        ${journal.mood ? `<span class="reflection-mood">${journal.mood}</span>` : ''}
        ${journal.text || '<em>No text</em>'}
      </div>
    </div>`;
  }
  
  // Study Sessions
  if(sessions.length) {
    const totalMins = sessions.reduce((a,s)=>a+s.duration, 0);
    const totalHours = Math.floor(totalMins / 60);
    const totalMinsRem = totalMins % 60;
    const totalStr = totalHours > 0 ? `${totalHours}h ${totalMinsRem}m` : `${totalMins}m`;
    
    html += `<div class="reflection-card">
      <div class="reflection-date">Study Sessions (${totalStr} total)</div>`;
    sessions.forEach(s => {
      const time = s.startTime ? new Date(s.startTime).toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit'
      }) : '‚Äî';
      const hrs = Math.floor(s.duration / 60);
      const mins = s.duration % 60;
      const durationStr = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
      html += `<div style="margin:8px 0;padding:8px;background:var(--bg-base);border-radius:var(--radius);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong style="color:var(--cream);">${s.subject}</strong>
          <span style="color:var(--amber);font-family:var(--font-mono);font-size:.85rem;">${durationStr}</span>
        </div>
        <div style="color:var(--cream-faint);font-size:.75rem;font-family:var(--font-mono);margin-top:4px;">Started at ${time}</div>
      </div>`;
    });
    html += `</div>`;
  }
  
  // Tasks
  if(tasks.length) {
    html += `<div class="reflection-card">
      <div class="reflection-date">Tasks Due</div>`;
    tasks.forEach(t => {
      const check = t.status==='done' ? '‚úì' : '‚óã';
      html += `<div style="margin:8px 0;color:var(--cream);">${check} ${t.title}</div>`;
    });
    html += `</div>`;
  }
  
  // Tests
  if(tests.length) {
    html += `<div class="reflection-card">
      <div class="reflection-date">Tests</div>`;
    tests.forEach(t => {
      const pct = Math.round((t.score/t.total)*100);
      html += `<div style="margin:8px 0;">
        <strong>${t.title}</strong> - ${t.subject}<br>
        <span style="color:var(--amber);font-family:var(--font-mono);">${t.score}/${t.total} (${pct}%)</span>
      </div>`;
    });
    html += `</div>`;
  }
  
  if(!html) {
    html = '<div class="empty-state">No activities recorded for this day</div>';
  }
  
  document.getElementById('date-details').innerHTML = html;
}

// ================================================================
//  STUDY TIMER
// ================================================================
let timerMinutes = 25;
let timerSeconds = 0;
let timerRunning = false;
let timerInterval = null;
let sessionStartTime = null;
let sessionDuration = 25;
let timerMode = 'timer'; // 'timer' or 'stopwatch'
let lapTimes = [];

function setTimerMode(mode) {
  if(timerRunning) {
    toast('Stop the timer first');
    return;
  }
  
  timerMode = mode;
  
  // Update mode button styles
  document.getElementById('mode-timer-btn').classList.toggle('btn-primary', mode === 'timer');
  document.getElementById('mode-stopwatch-btn').classList.toggle('btn-primary', mode === 'stopwatch');
  
  // Show/hide appropriate controls
  if(mode === 'timer') {
    document.getElementById('timer-mode-controls').classList.remove('hidden');
    document.getElementById('stopwatch-mode-controls').classList.add('hidden');
    document.getElementById('timer-mode-controls-full').classList.remove('hidden');
    document.getElementById('stopwatch-mode-controls-full').classList.add('hidden');
    timerMinutes = 25;
    timerSeconds = 0;
  } else {
    document.getElementById('timer-mode-controls').classList.add('hidden');
    document.getElementById('stopwatch-mode-controls').classList.remove('hidden');
    document.getElementById('timer-mode-controls-full').classList.add('hidden');
    document.getElementById('stopwatch-mode-controls-full').classList.remove('hidden');
    timerMinutes = 0;
    timerSeconds = 0;
    document.getElementById('lap-times').innerHTML = '';
    lapTimes = [];
  }
  
  updateTimerDisplay();
}

function lapStopwatch() {
  if(!timerRunning) return;
  const lapTime = `${String(timerMinutes).padStart(2,'0')}:${String(timerSeconds).padStart(2,'0')}`;
  lapTimes.push(lapTime);
  
  const lapContainer = document.getElementById('lap-times');
  const lapDiv = document.createElement('div');
  lapDiv.style.cssText = 'padding:8px;margin:4px 0;background:var(--bg-raised);border-radius:var(--radius);display:flex;justify-content:space-between;font-family:var(--font-mono);';
  lapDiv.innerHTML = `<span style="color:var(--cream-dim);">Lap ${lapTimes.length}</span><span style="color:var(--amber);">${lapTime}</span>`;
  lapContainer.insertBefore(lapDiv, lapContainer.firstChild);
}

function setTimer(mins) {
  if(timerMode === 'stopwatch') return;
  timerMinutes = mins;
  timerSeconds = 0;
  sessionDuration = mins;
  updateTimerDisplay();
}

function updateTimerDisplay() {
  const m = String(timerMinutes).padStart(2,'0');
  const s = String(timerSeconds).padStart(2,'0');
  const display = `${m}:${s}`;
  document.getElementById('timer-display').textContent = display;
  document.getElementById('timer-display-full').textContent = display;
}

function toggleTimer() {
  if(timerRunning) {
    pauseTimer();
  } else {
    startTimer();
  }
}

function startTimer() {
  if(timerRunning) return;
  timerRunning = true;
  sessionStartTime = new Date();
  
  // Update all start buttons
  const startBtns = ['timer-start-btn', 'timer-start-btn-full', 'stopwatch-start-btn', 'stopwatch-start-btn-full'];
  startBtns.forEach(id => {
    const btn = document.getElementById(id);
    if(btn) btn.textContent = 'Pause';
  });
  
  // Show lap button for stopwatch
  if(timerMode === 'stopwatch') {
    document.getElementById('lap-btn').style.display = 'inline-flex';
    document.getElementById('lap-btn-full').style.display = 'inline-flex';
  }
  
  // Use real clock for background-aware timing
  let timerStartWallClock = Date.now();
  let timerStartMinutes = timerMinutes;
  let timerStartSeconds = timerSeconds;

  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - timerStartWallClock) / 1000);
    
    if(timerMode === 'timer') {
      const totalStartSecs = timerStartMinutes * 60 + timerStartSeconds;
      const remaining = totalStartSecs - elapsed;
      if(remaining <= 0) {
        timerMinutes = 0; timerSeconds = 0;
        updateTimerDisplay();
        pauseTimer();
        saveSession();
        toast('Session complete! üéâ');
        sendNotification('Session Complete', 'Your study session is done!');
        return;
      }
      timerMinutes = Math.floor(remaining / 60);
      timerSeconds = remaining % 60;
    } else {
      const total = elapsed;
      timerMinutes = Math.floor(total / 60);
      timerSeconds = total % 60;
    }
    updateTimerDisplay();
  }, 500); // Poll every 500ms for accuracy
}

function pauseTimer() {
  timerRunning = false;
  clearInterval(timerInterval);
  
  const startBtns = ['timer-start-btn', 'timer-start-btn-full', 'stopwatch-start-btn', 'stopwatch-start-btn-full'];
  startBtns.forEach(id => {
    const btn = document.getElementById(id);
    if(btn) btn.textContent = 'Start';
  });
  
  // Save stopwatch session when paused
  if(timerMode === 'stopwatch' && sessionStartTime) {
    saveSession();
  }
}

function resetTimer() {
  pauseTimer();
  
  if(timerMode === 'timer') {
    timerMinutes = sessionDuration;
    timerSeconds = 0;
  } else {
    timerMinutes = 0;
    timerSeconds = 0;
    document.getElementById('lap-times').innerHTML = '';
    lapTimes = [];
    document.getElementById('lap-btn').style.display = 'none';
    document.getElementById('lap-btn-full').style.display = 'none';
  }
  
  sessionStartTime = null;
  updateTimerDisplay();
}

function saveSession() {
  const subject = document.getElementById('timer-subject').value.trim() || 'General';
  const endTime = new Date();
  
  let actualDuration;
  if(timerMode === 'stopwatch') {
    // For stopwatch, calculate from elapsed time
    actualDuration = timerMinutes + Math.round(timerSeconds / 60);
  } else {
    // For timer, calculate from start time
    actualDuration = sessionStartTime ? Math.round((endTime - sessionStartTime) / (1000 * 60)) : sessionDuration;
  }
  
  if(actualDuration === 0) return; // Don't save 0-minute sessions
  
  const session = {
    id: generateId(),
    date: todayStr(),
    subject,
    duration: actualDuration,
    startTime: sessionStartTime ? sessionStartTime.toISOString() : null,
    endTime: endTime.toISOString(),
    timestamp: Date.now(),
    mode: timerMode
  };
  
  const sessions = DB.get('study-sessions');
  sessions.push(session);
  localWrite('study-sessions', sessions);
  renderAnalytics();
  renderDashboard();
  
  sessionStartTime = new Date(); // Reset for next segment if continuing
}

function toggleFullscreen() {
  const fs = document.getElementById('fullscreen-timer');
  fs.classList.toggle('active');
}

// ================================================================
//  STUDY ANALYTICS
// ================================================================
function renderAnalytics() {
  const sessions = DB.get('study-sessions');
  
  // Calculate total study time
  const totalMins = sessions.reduce((a,s)=>a+s.duration, 0);
  const totalHours = Math.floor(totalMins / 60);
  const totalMinsRem = totalMins % 60;
  document.getElementById('total-hours').textContent = 
    totalHours > 0 ? `${totalHours}h ${totalMinsRem}m` : `${totalMins}m`;
  
  // Calculate 7-day average
  const weekAgo = new Date();
  weekAgo.setDate(weekAgo.getDate() - 7);
  const weekSessions = sessions.filter(s=>new Date(s.date)>=weekAgo);
  const weekMins = weekSessions.reduce((a,s)=>a+s.duration, 0);
  const avgDaily = Math.round(weekMins / 7);
  const avgHours = Math.floor(avgDaily / 60);
  const avgMins = avgDaily % 60;
  document.getElementById('avg-daily').textContent = 
    avgHours > 0 ? `${avgHours}h ${avgMins}m` : `${avgMins}m`;
  
  // Total sessions
  document.getElementById('total-sessions').textContent = sessions.length;
  
  // Group sessions by day
  const byDay = {};
  sessions.forEach(s => {
    if(!byDay[s.date]) byDay[s.date] = [];
    byDay[s.date].push(s);
  });
  
  // Sort days descending (most recent first)
  const sortedDays = Object.keys(byDay).sort((a,b)=>b.localeCompare(a));
  
  const container = document.getElementById('sessions-by-day');
  if(!sortedDays.length) {
    container.innerHTML = '<div class="empty-state">No study sessions recorded yet</div>';
    return;
  }
  
  container.innerHTML = sortedDays.map(date => {
    const daySessions = byDay[date];
    const dayTotal = daySessions.reduce((a,s)=>a+s.duration, 0);
    const dayHours = Math.floor(dayTotal / 60);
    const dayMins = dayTotal % 60;
    const dayLabel = new Date(date+'T00:00:00').toLocaleDateString('en-US', {
      weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
    });
    
    return `<div class="day-session-card">
      <div class="day-session-header">
        <div class="day-session-date">${dayLabel}</div>
        <div class="day-session-total">${dayHours>0 ? dayHours+'h ' : ''}${dayMins}m total</div>
      </div>
      ${daySessions.map(s => {
        const time = s.startTime ? new Date(s.startTime).toLocaleTimeString('en-US', {
          hour: '2-digit', minute: '2-digit'
        }) : '‚Äî';
        const hrs = Math.floor(s.duration / 60);
        const mins = s.duration % 60;
        const durationStr = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
        
        return `<div class="session-entry">
          <div class="session-subject">${s.subject}</div>
          <div class="session-time">
            <div class="session-duration">${durationStr}</div>
            <div class="session-timestamp">${time}</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');
}

// ================================================================
//  BROWN NOISE PLAYER
// ================================================================
let noiseAudio = null;
let noiseActive = false;

function initNoise() {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const bufferSize = 2 * audioContext.sampleRate;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const output = buffer.getChannelData(0);
  
  let lastOut = 0;
  for(let i=0; i<bufferSize; i++) {
    const white = Math.random() * 2 - 1;
    output[i] = (lastOut + (0.02 * white)) / 1.02;
    lastOut = output[i];
    output[i] *= 3.5;
  }
  
  const source = audioContext.createBufferSource();
  source.buffer = buffer;
  source.loop = true;
  
  const gainNode = audioContext.createGain();
  gainNode.gain.value = 0.5;
  
  source.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  noiseAudio = { source, gainNode, context: audioContext };
}

function toggleNoise() {
  if(!noiseAudio) initNoise();
  
  if(noiseActive) {
    noiseAudio.source.stop();
    noiseAudio = null;
    noiseActive = false;
    document.getElementById('noise-status').textContent = 'Off';
    document.getElementById('noise-status-full').textContent = 'Off';
    document.querySelectorAll('.noise-toggle').forEach(btn => {
      btn.classList.remove('btn-primary');
    });
  } else {
    if(!noiseAudio) initNoise();
    noiseAudio.source.start(0);
    noiseActive = true;
    document.getElementById('noise-status').textContent = 'On';
    document.getElementById('noise-status-full').textContent = 'On';
    document.querySelectorAll('.noise-toggle').forEach(btn => {
      btn.classList.add('btn-primary');
    });
  }
}

function updateVolume(value) {
  const vol = value / 100;
  document.getElementById('volume-label').textContent = `Volume: ${value}%`;
  document.getElementById('volume-label-full').textContent = `Volume: ${value}%`;
  document.querySelectorAll('.volume-slider').forEach(s => s.value = value);
  
  if(noiseAudio && noiseAudio.gainNode) {
    noiseAudio.gainNode.gain.value = vol;
  }
}

// ================================================================
//  EVENTS & REMINDERS
// ================================================================
function openAddEventModal() {
  const btn = document.getElementById('add-event-btn');
  const preDate = btn && btn.dataset.date ? btn.dataset.date : todayStr();
  document.getElementById('event-title').value = '';
  document.getElementById('event-date').value = preDate;
  document.getElementById('event-time').value = '';
  document.getElementById('event-notes').value = '';
  document.getElementById('event-reminder').value = '15';
  document.getElementById('add-event-modal').classList.remove('hidden');
}

function saveEvent() {
  const title = document.getElementById('event-title').value.trim();
  const date = document.getElementById('event-date').value;
  const time = document.getElementById('event-time').value;
  if(!title || !date) { toast('Please enter a title and date'); return; }
  
  const reminderMins = parseInt(document.getElementById('event-reminder').value);
  const reminderLabels = {'0':'At event time','5':'5 min before','10':'10 min before',
    '15':'15 min before','30':'30 min before','60':'1 hour before','1440':'1 day before'};
  
  const ev = {
    id: generateId(),
    title,
    date,
    time: time || '00:00',
    notes: document.getElementById('event-notes').value.trim(),
    reminderMins,
    reminderLabel: reminderLabels[reminderMins] || (reminderMins + ' min before'),
    created: Date.now()
  };
  
  const list = DB.get('events');
  list.push(ev);
  localWrite('events', list);
  closeModal('add-event-modal');
  toast('Event saved!');
  
  // Request notification permission and schedule reminder
  scheduleReminder(ev);
  renderCalendar();
  if(selectedDate === date) selectDate(date);
}

function deleteEvent(id) {
  const updated = DB.get('events').filter(e => e.id !== id);
  localWrite('events', updated);
  toast('Event deleted');
  renderCalendar();
  if(selectedDate) selectDate(selectedDate);
}

// ================================================================
//  NOTIFICATIONS
// ================================================================
function sendNotification(title, body) {
  if(Notification.permission === 'granted') {
    new Notification(title, { body, icon: '' });
  }
}

function scheduleReminder(ev) {
  if(!ev.time || ev.time === '00:00') return;
  
  // Request permission first
  if(Notification.permission === 'default') {
    Notification.requestPermission().then(perm => {
      if(perm === 'granted') scheduleReminderTimeout(ev);
    });
  } else if(Notification.permission === 'granted') {
    scheduleReminderTimeout(ev);
  }
}

function scheduleReminderTimeout(ev) {
  const eventTime = new Date(ev.date + 'T' + ev.time);
  const reminderTime = new Date(eventTime.getTime() - ev.reminderMins * 60 * 1000);
  const msUntil = reminderTime.getTime() - Date.now();
  
  if(msUntil <= 0) return; // Already passed
  if(msUntil > 7 * 24 * 60 * 60 * 1000) return; // More than 7 days away, skip (browser won't keep it)
  
  setTimeout(() => {
    const label = ev.reminderMins === 0 ? 'is now!' : `in ${ev.reminderMins} min`;
    sendNotification(`üìÖ ${ev.title}`, `Event ${label}`);
  }, msUntil);
}

function requestNotificationPermission() {
  if(!('Notification' in window)) {
    toast('Notifications not supported in this browser');
    return;
  }
  Notification.requestPermission().then(perm => {
    if(perm === 'granted') toast('Notifications enabled!');
    else toast('Notifications blocked. Enable in browser settings.');
  });
}

// Re-schedule reminders for upcoming events on page load
function rescheduleAllReminders() {
  if(!('Notification' in window) || Notification.permission !== 'granted') return;
  const events = DB.get('events');
  const now = Date.now();
  events.forEach(ev => {
    if(!ev.time || ev.time === '00:00') return;
    const eventTime = new Date(ev.date + 'T' + ev.time);
    if(eventTime.getTime() > now) scheduleReminderTimeout(ev);
  });
}

// ================================================================
//  INIT
// ================================================================
// events already initialized above

// Wait for all scripts to load before touching Firebase
window.addEventListener('load', function() {
  initFirebase();
});
setTimerMode('timer');
renderDashboard();
rescheduleAllReminders();

// Ask for notification permission on first load (after a short delay)
setTimeout(() => {
  if('Notification' in window && Notification.permission === 'default') {
    requestNotificationPermission();
  }
}, 3000);
</script>

<!-- Sync Debug Panel (tap clock 3x to show) -->
<div id="sync-debug-panel" style="display:none;position:fixed;bottom:70px;left:0;right:0;background:#0a0907;border-top:2px solid #d4a854;z-index:9000;padding:12px;max-height:220px;overflow-y:auto;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <span style="font-family:monospace;font-size:12px;color:#d4a854;">SYNC DEBUG</span>
    <div style="display:flex;gap:8px;">
      <button onclick="_doPush()" style="font-family:monospace;font-size:11px;background:#2d2720;border:1px solid #5a4d42;color:#e4bc6e;padding:3px 8px;cursor:pointer;border-radius:3px;">Force Push</button>
      <button onclick="syncFromCloud()" style="font-family:monospace;font-size:11px;background:#2d2720;border:1px solid #5a4d42;color:#5a9a85;padding:3px 8px;cursor:pointer;border-radius:3px;">Pull Cloud</button>
      <button onclick="document.getElementById('sync-debug-panel').style.display='none'" style="font-family:monospace;font-size:11px;background:#2d2720;border:1px solid #5a4d42;color:#8a7a65;padding:3px 8px;cursor:pointer;border-radius:3px;">Close</button>
    </div>
  </div>
  <div style="font-family:monospace;font-size:11px;color:#8a7a65;margin-bottom:6px;" id="sync-debug-state"></div>
  <div id="sync-debug-log"></div>
</div>
</body>
</html>
